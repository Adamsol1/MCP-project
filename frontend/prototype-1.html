<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Prototype 1 - Chat UI</title>
            <style>
      :root {
        color-scheme: light;
        --bg: #f3efe6;
        --bg-accent: #f8f4ec;
        --panel: #ffffff;
        --panel-2: #f5f0e6;
        --line: #ded6c8;
        --text: #1d1a16;
        --muted: #6b6358;
        --shadow: 0 10px 24px rgba(26, 23, 18, 0.12);
        --accent: #b24a2b;
        --accent-2: #2b3f8c;
        --success: #2b8f5f;
        --danger: #b33b3b;
      }

      [data-theme="dark"] {
        color-scheme: dark;
        --bg: #14130f;
        --bg-accent: #1a1915;
        --panel: #1c1b18;
        --panel-2: #23211d;
        --line: #34312a;
        --text: #f1ede6;
        --muted: #b8b0a4;
        --shadow: 0 16px 30px rgba(0, 0, 0, 0.5);
        --accent: #e07b5d;
        --accent-2: #8fa5ff;
        --success: #5bd39b;
        --danger: #ff7a7a;
      }

      * {
        box-sizing: border-box;
      }

      body {
        margin: 0;
        font-family: "Georgia", "Times New Roman", serif;
        background: radial-gradient(circle at top left, var(--bg-accent), var(--bg));
        color: var(--text);
        height: 100vh;
        overflow: hidden;
        display: flex;
        flex-direction: column;
      }

      #app {
        flex: 1;
        min-height: 0;
      }

      .app {
        height: 100%;
        width: 100%;
      }

      .app-shell {
        display: grid;
        grid-template-columns: 260px minmax(0, 1fr);
        gap: 18px;
        padding: 16px 18px;
        height: 100%;
      }

      .app-shell.rail-collapsed {
        grid-template-columns: 84px minmax(0, 1fr);
      }

      .sidebar {
        background: var(--panel);
        border: 1px solid var(--line);
        border-radius: 18px;
        display: flex;
        flex-direction: column;
        min-height: 0;
        box-shadow: var(--shadow);
        transition: width 0.2s ease;
      }

      .rail-header {
        display: flex;
        flex-direction: column;
        gap: 12px;
        padding: 18px 16px 12px;
        border-bottom: 1px solid var(--line);
      }

      .brand {
        font-family: "Trebuchet MS", "Segoe UI", sans-serif;
        font-weight: 700;
        font-size: 1.05rem;
        letter-spacing: 0.6px;
        text-transform: uppercase;
      }

      .rail-actions {
        display: flex;
        gap: 8px;
      }

      .sidebar-header,
      .sidebar-header button,
      .sidebar-header .icon-btn {
        display: none;
      }

      .icon-btn {
        background: var(--panel-2);
        border: 1px solid var(--line);
        padding: 8px 10px;
        border-radius: 10px;
        cursor: pointer;
        color: var(--text);
        box-shadow: var(--shadow);
        font-family: "Trebuchet MS", "Segoe UI", sans-serif;
        font-size: 0.85rem;
      }

      .sidebar-body {
        padding: 14px 16px 18px;
        display: flex;
        flex-direction: column;
        gap: 12px;
        height: 100%;
        min-height: 0;
      }

      .sidebar.collapsed .sidebar-body > * {
        opacity: 0;
        pointer-events: none;
        height: 0;
        margin: 0;
      }

      .new-chat {
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 8px;
        padding: 10px 12px;
        border-radius: 12px;
        border: 1px solid var(--line);
        background: var(--accent);
        color: #fff7f1;
        font-weight: 700;
        cursor: pointer;
        font-family: "Trebuchet MS", "Segoe UI", sans-serif;
      }

      .search {
        display: flex;
        flex-direction: column;
        gap: 6px;
        background: var(--panel-2);
        border: 1px solid var(--line);
        border-radius: 12px;
        padding: 10px 12px;
        font-family: "Trebuchet MS", "Segoe UI", sans-serif;
        font-size: 0.85rem;
        text-transform: uppercase;
        letter-spacing: 0.6px;
        color: var(--muted);
      }

      .search input {
        background: transparent;
        border: none;
        outline: none;
        color: var(--text);
        width: 100%;
        font-family: "Georgia", "Times New Roman", serif;
        font-size: 0.95rem;
      }

      .conversation-list {
        display: flex;
        flex-direction: column;
        gap: 10px;
        overflow-y: auto;
        padding-right: 4px;
      }

      .conversation-item {
        padding: 12px 12px;
        border-radius: 14px;
        border: 1px solid transparent;
        background: var(--panel-2);
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: space-between;
        gap: 8px;
      }

      .conversation-item.active {
        border-color: var(--accent);
        background: #fcefe9;
      }

      [data-theme="dark"] .conversation-item.active {
        background: #2a1e1b;
      }

      .conversation-title {
        font-weight: 700;
        font-size: 0.95rem;
      }

      .conversation-meta {
        font-size: 0.75rem;
        color: var(--muted);
      }

      .conversation-actions {
        display: flex;
        gap: 6px;
        font-family: "Trebuchet MS", "Segoe UI", sans-serif;
      }

      .icon-only {
        border: 1px solid var(--line);
        background: transparent;
        color: var(--muted);
        border-radius: 10px;
        padding: 4px 8px;
        cursor: pointer;
        font-size: 0.7rem;
        text-transform: uppercase;
        letter-spacing: 0.5px;
      }

      .main {
        display: flex;
        flex-direction: column;
        min-height: 0;
      }

      .studio-header {
        display: flex;
        align-items: center;
        justify-content: space-between;
        padding: 18px 20px;
        border: 1px solid var(--line);
        border-radius: 18px;
        background: var(--panel);
        box-shadow: var(--shadow);
      }

      .header-left {
        display: flex;
        align-items: center;
        gap: 12px;
      }

      .title-block {
        display: flex;
        flex-direction: column;
        gap: 4px;
      }

      .eyebrow {
        font-family: "Trebuchet MS", "Segoe UI", sans-serif;
        font-size: 0.7rem;
        letter-spacing: 1.2px;
        text-transform: uppercase;
        color: var(--muted);
      }

      .studio-header .title {
        font-weight: 700;
        font-size: 1.2rem;
      }

      .header-actions {
        display: flex;
        align-items: center;
        gap: 10px;
      }

      .status-tag {
        padding: 6px 10px;
        border-radius: 999px;
        border: 1px solid var(--line);
        background: var(--panel-2);
        font-family: "Trebuchet MS", "Segoe UI", sans-serif;
        font-size: 0.7rem;
        letter-spacing: 0.5px;
        text-transform: uppercase;
        color: var(--muted);
      }

      .ghost {
        border: 1px solid var(--line);
        background: transparent;
        border-radius: 10px;
        padding: 8px 12px;
        cursor: pointer;
        font-family: "Trebuchet MS", "Segoe UI", sans-serif;
        color: var(--text);
      }

      .storyboard {        margin-top: 16px;        background: var(--panel);        border: 1px solid var(--line);        border-radius: 18px;        padding: 16px 18px;        box-shadow: var(--shadow);        display: flex;        flex-direction: column;        gap: 12px;        min-height: 0;        flex: 1;      }

      .story-meta {
        display: flex;
        gap: 16px;
        flex-wrap: wrap;
        font-family: "Trebuchet MS", "Segoe UI", sans-serif;
        font-size: 0.75rem;
        text-transform: uppercase;
        letter-spacing: 0.8px;
        color: var(--muted);
      }

      .chat-log {
        flex: 1;
        overflow-y: auto;
        display: flex;
        flex-direction: column;
        gap: 12px;
        padding: 18px 6px 220px;
        min-height: 0;
      }

      .message {
        display: flex;
        flex-direction: column;
        gap: 8px;
        padding: 12px 14px;
        border-radius: 16px;
        border: 1px solid var(--line);
        background: var(--panel-2);
      }

      .message.user {
        border-left: 4px solid var(--accent);
        background: #fff5ee;
        align-self: flex-end;
      }

      .message.assistant {
        border-left: 4px solid var(--accent-2);
        background: #f2f4ff;
        align-self: flex-start;
      }

      [data-theme="dark"] .message.user {
        background: #2a1d18;
      }

      [data-theme="dark"] .message.assistant {
        background: #1e2334;
      }

      .bubble {
        line-height: 1.5;
      }

      .message-actions {
        display: flex;
        align-items: center;
        gap: 10px;
        font-family: "Trebuchet MS", "Segoe UI", sans-serif;
        font-size: 0.7rem;
        text-transform: uppercase;
        letter-spacing: 0.6px;
        color: var(--muted);
      }

      .copy-btn {
        border: 1px solid var(--line);
        background: transparent;
        border-radius: 10px;
        padding: 4px 8px;
        cursor: pointer;
        color: var(--muted);
      }

      .run-trace {
        margin-top: 8px;
        border: 1px solid var(--line);
        background: var(--panel);
        border-radius: 12px;
        padding: 10px 12px;
      }

      .run-trace summary {
        cursor: pointer;
        font-weight: 600;
        font-family: "Trebuchet MS", "Segoe UI", sans-serif;
      }

      .run-step {
        font-size: 0.85rem;
        padding: 6px 0;
        border-bottom: 1px solid var(--line);
      }

      .run-step:last-child {
        border-bottom: none;
      }

      .composer {
        position: fixed;
        left: calc(16px + 260px);
        right: 16px;
        bottom: 16px;
        background: var(--panel);
        border: 1px solid var(--line);
        border-radius: 16px;
        padding: 14px 16px;
        display: flex;
        gap: 12px;
        align-items: flex-end;
        box-shadow: 0 -6px 18px rgba(26, 23, 18, 0.08);
        z-index: 5;
      }

      .composer textarea {
        flex: 1;
        resize: none;
        border: 1px solid var(--line);
        border-radius: 16px;
        padding: 14px 16px;
        font-family: inherit;
        font-size: 1rem;
        background: var(--panel-2);
        color: var(--text);
        min-height: 72px;
        max-height: 180px;
        overflow-y: auto;
      }

      .composer button {
        border: none;
        border-radius: 12px;
        padding: 12px 16px;
        font-weight: 700;
        cursor: pointer;
        background: var(--accent);
        color: #fff7f1;
        min-width: 90px;
        font-family: "Trebuchet MS", "Segoe UI", sans-serif;
      }

      .composer button[disabled] {
        opacity: 0.5;
        cursor: not-allowed;
      }

      .jump-latest {
        align-self: flex-end;
        margin-top: 12px;
        background: var(--panel);
        border: 1px solid var(--line);
        border-radius: 999px;
        padding: 8px 14px;
        box-shadow: var(--shadow);
        cursor: pointer;
        font-family: "Trebuchet MS", "Segoe UI", sans-serif;
      }

      .sidebar-toggle-mobile {
        display: none;
      }

      .drawer-backdrop {
        display: none;
      }

      @media (max-width: 1200px) {
        .app-shell {
          grid-template-columns: 240px minmax(0, 1fr);
        }

        .app-shell.rail-collapsed {
          grid-template-columns: 84px minmax(0, 1fr);
        }
      }

      @media (max-width: 900px) {
        .app-shell {
          grid-template-columns: minmax(0, 1fr);
        }

        .sidebar {
          position: fixed;
          left: 0;
          top: 0;
          bottom: 0;
          z-index: 20;
          transform: translateX(-110%);
          max-width: 280px;
        }

        .sidebar.open {
          transform: translateX(0);
        }

        .drawer-backdrop {
          display: block;
          position: fixed;
          inset: 0;
          background: rgba(0, 0, 0, 0.4);
          opacity: 0;
          pointer-events: none;
          transition: opacity 0.2s ease;
          z-index: 10;
        }

        .drawer-backdrop.active {
          opacity: 1;
          pointer-events: auto;
        }

        .sidebar-toggle-mobile {
          display: inline-flex;
        }

        .composer {
          left: 16px;
          right: 16px;
        }
      }

    </style>
  </head>
  <body>
    <nav style="display:flex;gap:12px;padding:12px 16px;border-bottom:1px solid #d6dbe6;background:#ffffff;">
      <a href="/index.html">Home</a>
      <a href="/prototype-1.html">Prototype 1</a>
      <a href="/prototype-2.html">Prototype 2</a>
      <a href="/prototype-3.html">Prototype 3</a>
    </nav>

        <div id="app"></div>

    <script>
      const state = {
        theme: "light",
        sidebarCollapsed: false,
        sidebarOpenMobile: false,
        conversations: [],
        activeConversationId: "",
        streaming: { active: false, cancelToken: null },
      };

      const createConversation = () => {
        const id = "convo_" + Date.now().toString(36);
        const convo = {
          id,
          title: "New chat",
          updatedAt: Date.now(),
          messages: [],
        };
        state.conversations.unshift(convo);
        state.activeConversationId = id;
        
        return convo;
      };

      const renameConversation = (id) => {
        const convo = state.conversations.find((c) => c.id === id);
        if (!convo) return;
        const nextTitle = prompt("Rename conversation", convo.title);
        if (!nextTitle) return;
        convo.title = nextTitle.trim().slice(0, 60);
        convo.updatedAt = Date.now();
        
      };

      const deleteConversation = (id) => {
        const index = state.conversations.findIndex((c) => c.id === id);
        if (index === -1) return;
        const ok = confirm("Delete this conversation?");
        if (!ok) return;
        state.conversations.splice(index, 1);
        if (state.activeConversationId === id) {
          state.activeConversationId = state.conversations[0]?.id || "";
        }
        
      };

      const addMessage = (convoId, role, content, meta) => {
        const convo = state.conversations.find((c) => c.id === convoId);
        if (!convo) return;
        convo.messages.push({
          id: "msg_" + Date.now().toString(36) + Math.random().toString(36),
          role,
          content,
          createdAt: Date.now(),
          meta: meta || null,
        });
        convo.updatedAt = Date.now();
        
      };

      const mockGenerateResponse = (userText) => {
        const baseReplies = [
          "I reviewed the indicators and found a few possible pivots.",
          "Here's a quick assessment of the telemetry you shared.",
          "I ran a lightweight enrichment pass on the sample.",
        ];

        const iocSnippets = [
          "Extracted IOCs: 1.2.3.4, evil-domain.com, hash: e3b0c442...",
          "Extracted IOCs: 5.6.7.8, suspicious-login.net, hash: 2cf24dba...",
        ];

        const confidence = ["Confidence: medium.", "Confidence: high."];

        const nextSteps =
          "Recommended next steps:\n- Enrich domains with passive DNS\n- Check endpoint telemetry for matching hashes\n- Share with IR team";

        const includeTool = Math.random() > 0.6;
        const includeTrace = Math.random() > 0.5;

        const responseText =
          baseReplies[Math.floor(Math.random() * baseReplies.length)] +
          "\n\n" +
          iocSnippets[Math.floor(Math.random() * iocSnippets.length)] +
          "\n" +
          confidence[Math.floor(Math.random() * confidence.length)] +
          "\n\n" +
          nextSteps;

        const toolText = includeTool
          ? "Tool output: Extracted IOCs, normalized 3 indicators, 2 matches found."
          : null;

        const runTrace = includeTrace
          ? {
              steps: [
                {
                  name: "Collection",
                  duration: "0.6s",
                  logs: ["Pulled telemetry bundle", "Parsed 12 events"],
                },
                {
                  name: "Normalize",
                  duration: "0.4s",
                  logs: ["Normalized IPs", "Validated hashes"],
                },
                {
                  name: "Analyze",
                  duration: "1.1s",
                  logs: ["Matched against watchlist", "Risk scored"],
                },
                {
                  name: "Review",
                  duration: "0.5s",
                  logs: ["Flagged 2 indicators", "Prepared summary"],
                },
              ],
            }
          : null;

        return { text: responseText, toolText, runTrace };
      };

      const streamAssistantMessage = (fullText, onChunk, onDone, cancelToken) => {
        let index = 0;
        const interval = setInterval(() => {
          if (cancelToken.cancelled) {
            clearInterval(interval);
            onDone(true);
            return;
          }
          index += Math.floor(Math.random() * 5) + 2;
          const chunk = fullText.slice(0, index);
          onChunk(chunk);
          if (index >= fullText.length) {
            clearInterval(interval);
            onDone(false);
          }
        }, 45);
      };

      const formatTime = (timestamp) => {
        const date = new Date(timestamp);
        return date.toLocaleTimeString([], { hour: "2-digit", minute: "2-digit" });
      };

      const getActiveConversation = () =>
        state.conversations.find((c) => c.id === state.activeConversationId);

      const ensureActiveConversation = () => {
        if (!state.conversations.length) {
          createConversation();
        }
        if (!state.activeConversationId) {
          state.activeConversationId = state.conversations[0].id;
        }
      };

      const renderMessage = (message) => {
        const safeContent = message.content
          .split("\n")
          .map((line) => `<div>${line}</div>`)
          .join("");

        const copyButton =
          message.role === "assistant"
            ? `<button class="copy-btn" data-action="copy" data-id="${message.id}">Copy</button>`
            : "";

        const runTrace =
          message.meta && message.meta.runTrace
            ? `<details class="run-trace"><summary>View details</summary>${message.meta.runTrace.steps
                .map(
                  (step) =>
                    `<div class="run-step"><strong>${step.name}</strong> · ${step.duration}<br/>${step.logs
                      .map((log) => `<span>• ${log}</span>`)
                      .join("<br/>")}</div>`
                )
                .join("")}</details>`
            : "";

        return `
          <div class="message ${message.role}">
            <div class="bubble">${safeContent}</div>
            <div class="message-actions">
              <span>${formatTime(message.createdAt)}</span>
              ${copyButton}
            </div>
            ${runTrace}
          </div>
        `;
      };

      const render = () => {
        ensureActiveConversation();
        document.documentElement.setAttribute("data-theme", state.theme);

        const activeConversation = getActiveConversation();
        const updatedLabel = activeConversation
          ? new Date(activeConversation.updatedAt).toLocaleString()
          : "-";
        const lastRole = activeConversation?.messages.length
          ? activeConversation.messages[activeConversation.messages.length - 1].role
          : "-";
        const query = state.searchQuery || "";
        const filtered = state.conversations.filter((c) =>
          c.title.toLowerCase().includes(query.toLowerCase())
        );

        const app = document.getElementById("app");
                app.innerHTML = `
          <div class="drawer-backdrop ${state.sidebarOpenMobile ? "active" : ""}" data-action="close-drawer"></div>
          <div class="app-shell app notebook ${state.sidebarCollapsed ? "rail-collapsed" : ""}">
            <aside class="sidebar ${state.sidebarCollapsed ? "collapsed" : ""} ${state.sidebarOpenMobile ? "open" : ""}">
              <div class="rail-header">
                
                <div class="rail-actions">
                  <button class="icon-btn" data-action="toggle-collapse">Collapse</button>
                  <button class="icon-btn" data-action="toggle-theme">${
                    state.theme === "light" ? "Dark" : "Light"
                  }</button>
                </div>
              </div>
              <div class="sidebar-body">
                <button class="new-chat" data-action="new-chat">New session</button>
<div class="conversation-list">
                  ${filtered
                    .map(
                      (convo) => `
                      <div class="conversation-item ${
                        convo.id === state.activeConversationId ? "active" : ""
                      }" data-action="open" data-id="${convo.id}">
                        <div>
                          <div class="conversation-title">${convo.title}</div>
                          <div class="conversation-meta">${new Date(
                            convo.updatedAt
                          ).toLocaleDateString()}</div>
                        </div>
                        <div class="conversation-actions">
                          <button class="icon-only" title="Rename" data-action="rename" data-id="${convo.id}">Rename</button>
                          <button class="icon-only" title="Delete" data-action="delete" data-id="${convo.id}">Delete</button>
                        </div>
                      </div>
                    `
                    )
                    .join("")}
                </div>
              </div>
            </aside>

            <main class="main canvas">
<section class="storyboard">
                <div class="story-meta">
                  <div class="meta-item">Entries: ${activeConversation?.messages.length || 0}</div>
                  <div class="meta-item">Updated: ${updatedLabel}</div>
                  <div class="meta-item">Last speaker: ${lastRole}</div>
                </div>
                <div class="chat-log" id="chat-log">
                  ${activeConversation?.messages.map(renderMessage).join("") || ""}
                </div>
              </section>

              <button class="jump-latest" style="display: none" data-action="jump">Jump to latest</button>

              <div class="composer">
                <textarea
                  id="composer"
                  rows="1"
                  placeholder="Add a note to this session..."
                ></textarea>
                <button id="send-btn" ${state.streaming.active ? "" : "disabled"} data-action="send">${
                  state.streaming.active ? "Stop" : "Send"
                }</button>
              </div>
            </main>
          </div>
        `;

        const textarea = document.getElementById("composer");
        const sendBtn = document.getElementById("send-btn");
        const chatLog = document.getElementById("chat-log");
        const jumpBtn = document.querySelector(".jump-latest");

        const updateSendState = () => {
          if (!state.streaming.active) {
            sendBtn.disabled = textarea.value.trim().length === 0;
          }
        };

        const autoGrow = () => {
          textarea.style.height = "auto";
          textarea.style.height = Math.min(textarea.scrollHeight, 160) + "px";
          updateSendState();
        };

        textarea.addEventListener("input", autoGrow);
        autoGrow();

        const handleScroll = () => {
          const nearBottom =
            chatLog.scrollHeight - chatLog.scrollTop - chatLog.clientHeight < 120;
          jumpBtn.style.display = nearBottom ? "none" : "inline-flex";
        };

        chatLog.addEventListener("scroll", handleScroll);
        handleScroll();

        const scrollToBottom = () => {
          chatLog.scrollTop = chatLog.scrollHeight;
        };

        if (!state.preventAutoScroll) {
          scrollToBottom();
        }
      };

      const sendMessage = () => {
        const textarea = document.getElementById("composer");
        const text = textarea.value.trim();
        if (!text || state.streaming.active) return;

        const activeId = state.activeConversationId;
        addMessage(activeId, "user", text);
        textarea.value = "";
        state.preventAutoScroll = false;
        render();

        const response = mockGenerateResponse(text);
        if (response.toolText) {
          addMessage(activeId, "tool", response.toolText);
        }

        const assistantMessage = {
          id: "msg_" + Date.now().toString(36),
          role: "assistant",
          content: "",
          createdAt: Date.now(),
          meta: response.runTrace ? { runTrace: response.runTrace } : null,
        };

        const convo = getActiveConversation();
        convo.messages.push(assistantMessage);

        state.streaming.active = true;
        state.streaming.cancelToken = { cancelled: false };
        
        render();

        streamAssistantMessage(
          response.text,
          (chunk) => {
            assistantMessage.content = chunk;
            const chatLog = document.getElementById("chat-log");
            const nearBottom =
              chatLog.scrollHeight - chatLog.scrollTop - chatLog.clientHeight < 140;
            state.preventAutoScroll = !nearBottom;
            render();
          },
          (cancelled) => {
            state.streaming.active = false;
            if (cancelled) {
              assistantMessage.content += "\n\n[Response cancelled]";
            }
            
            render();
          },
          state.streaming.cancelToken
        );
      };

      const clearChat = () => {
        const convo = getActiveConversation();
        if (!convo) return;
        const ok = confirm("Clear this chat?");
        if (!ok) return;
        convo.messages = [];
        convo.updatedAt = Date.now();
        
        render();
      };

      const handleClick = (event) => {
        const actionEl = event.target.closest("[data-action]");
        if (!actionEl) return;
        const action = actionEl.dataset.action;
        const id = actionEl.dataset.id;

        if (action === "toggle-collapse") {
          state.sidebarCollapsed = !state.sidebarCollapsed;
          
          render();
          return;
        }

        if (action === "toggle-theme") {
          state.theme = state.theme === "light" ? "dark" : "light";
          
          render();
          return;
        }

        if (action === "new-chat") {
          createConversation();
          render();
          return;
        }

        if (action === "open" && id) {
          state.activeConversationId = id;
          state.sidebarOpenMobile = false;
          
          render();
          return;
        }

        if (action === "rename" && id) {
          renameConversation(id);
          render();
          return;
        }

        if (action === "delete" && id) {
          deleteConversation(id);
          render();
          return;
        }

        if (action === "send") {
          if (state.streaming.active) {
            if (state.streaming.cancelToken) {
              state.streaming.cancelToken.cancelled = true;
            }
          } else {
            sendMessage();
          }
          return;
        }

        if (action === "copy" && id) {
          const convo = getActiveConversation();
          const msg = convo?.messages.find((m) => m.id === id);
          if (msg) {
            navigator.clipboard.writeText(msg.content || "");
          }
          return;
        }

        if (action === "clear-chat") {
          clearChat();
          return;
        }

        if (action === "open-drawer") {
          state.sidebarOpenMobile = true;
          render();
          return;
        }

        if (action === "close-drawer") {
          state.sidebarOpenMobile = false;
          render();
          return;
        }

        if (action === "jump") {
          const chatLog = document.getElementById("chat-log");
          chatLog.scrollTop = chatLog.scrollHeight;
          return;
        }
      };

      const handleInput = (event) => {
        if (event.target.matches("[data-action='search']")) {
          state.searchQuery = event.target.value;
          render();
        }
      };

      const handleKeydown = (event) => {
        const textarea = event.target.closest("#composer");
        if (!textarea) return;
        if (event.key === "Enter" && !event.shiftKey) {
          event.preventDefault();
          sendMessage();
        }
      };

      ensureActiveConversation();
      if (!state.conversations.length) {
        const convo = createConversation();
        addMessage(
          convo.id,
          "assistant",
          "Welcome to the Prototype 1 chat UI. Ask me about your threat intel case!"
        );
      }

      document.addEventListener("click", handleClick);
      document.addEventListener("input", handleInput);
      document.addEventListener("keydown", handleKeydown);

      render();
    </script>
  </body>
</html>
