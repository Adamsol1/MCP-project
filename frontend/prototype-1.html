<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Prototype 1 - Chat UI</title>
    <style>
      :root {
        color-scheme: light;
        --bg: #f6f7fb;
        --panel: #ffffff;
        --panel-2: #f2f4f8;
        --border: #d6dbe6;
        --text: #1f2430;
        --muted: #6b7383;
        --shadow: 0 6px 18px rgba(20, 24, 35, 0.08);
        --accent: #2b6cf6;
        --accent-2: #1a56d6;
        --success: #1f9d5c;
        --danger: #d64545;
      }

      [data-theme="dark"] {
        color-scheme: dark;
        --bg: #0f1117;
        --panel: #151923;
        --panel-2: #1b2230;
        --border: #2a3242;
        --text: #e6e9f2;
        --muted: #9aa3b2;
        --shadow: 0 10px 26px rgba(0, 0, 0, 0.4);
        --accent: #6ea3ff;
        --accent-2: #3d7bff;
        --success: #4cc38a;
        --danger: #ff6b6b;
      }

      * {
        box-sizing: border-box;
      }

      body {
        margin: 0;
        font-family: "Segoe UI", Tahoma, Geneva, Verdana, sans-serif;
        background: var(--bg);
        color: var(--text);
        height: 100vh;
        overflow: hidden;
      }

      .app {
        display: flex;
        height: 100vh;
        width: 100vw;
      }

      .sidebar {
        width: 280px;
        min-width: 280px;
        background: var(--panel);
        border-right: 1px solid var(--border);
        display: flex;
        flex-direction: column;
        transition: width 0.2s ease;
      }

      .sidebar.collapsed {
        width: 72px;
        min-width: 72px;
      }

      .sidebar-header {
        display: flex;
        align-items: center;
        justify-content: space-between;
        padding: 14px 16px;
        border-bottom: 1px solid var(--border);
        gap: 8px;
      }

      .sidebar-header button,
      .sidebar-header .icon-btn {
        background: var(--panel-2);
        border: 1px solid var(--border);
        padding: 8px 10px;
        border-radius: 10px;
        cursor: pointer;
        color: var(--text);
        box-shadow: var(--shadow);
      }

      .sidebar-header .icon-btn {
        width: 36px;
        height: 36px;
        display: inline-flex;
        align-items: center;
        justify-content: center;
      }

      .sidebar-body {
        padding: 12px 14px;
        display: flex;
        flex-direction: column;
        gap: 12px;
        height: 100%;
      }

      .sidebar.collapsed .sidebar-body > * {
        opacity: 0;
        pointer-events: none;
        height: 0;
        margin: 0;
      }

      .new-chat {
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 8px;
        padding: 10px 12px;
        border-radius: 12px;
        border: 1px solid var(--border);
        background: var(--accent);
        color: white;
        font-weight: 600;
        cursor: pointer;
        box-shadow: var(--shadow);
      }

      .search {
        display: flex;
        align-items: center;
        gap: 6px;
        background: var(--panel-2);
        border: 1px solid var(--border);
        border-radius: 10px;
        padding: 8px 10px;
      }

      .search input {
        background: transparent;
        border: none;
        outline: none;
        color: var(--text);
        width: 100%;
      }

      .conversation-list {
        display: flex;
        flex-direction: column;
        gap: 8px;
        overflow-y: auto;
        padding-right: 4px;
      }

      .conversation-item {
        padding: 10px 12px;
        border-radius: 12px;
        border: 1px solid transparent;
        background: var(--panel-2);
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: space-between;
        gap: 8px;
      }

      .conversation-item.active {
        border-color: var(--accent);
        background: rgba(43, 108, 246, 0.15);
      }

      .conversation-title {
        font-weight: 600;
        font-size: 0.92rem;
      }

      .conversation-meta {
        font-size: 0.72rem;
        color: var(--muted);
      }

      .conversation-actions {
        display: flex;
        gap: 6px;
      }

      .icon-only {
        border: 1px solid var(--border);
        background: transparent;
        color: var(--muted);
        border-radius: 8px;
        width: 26px;
        height: 26px;
        display: inline-flex;
        align-items: center;
        justify-content: center;
        cursor: pointer;
      }

      .main {
        flex: 1;
        display: flex;
        flex-direction: column;
        height: 100%;
        position: relative;
      }

      .topbar {
        display: flex;
        align-items: center;
        justify-content: space-between;
        padding: 14px 20px;
        border-bottom: 1px solid var(--border);
        background: var(--panel);
      }

      .topbar .title {
        font-weight: 700;
        font-size: 1.1rem;
      }

      .topbar-actions {
        display: flex;
        gap: 10px;
      }

      .topbar button {
        border: 1px solid var(--border);
        background: var(--panel-2);
        padding: 8px 10px;
        border-radius: 10px;
        cursor: pointer;
        color: var(--text);
      }

      .chat-log {
        flex: 1;
        overflow-y: auto;
        padding: 24px 20px 120px;
        display: flex;
        flex-direction: column;
        gap: 18px;
      }

      .message {
        display: flex;
        flex-direction: column;
        gap: 6px;
      }

      .message.user {
        align-items: flex-end;
      }

      .message.assistant {
        align-items: flex-start;
      }

      .message.tool {
        align-items: stretch;
      }

      .bubble {
        max-width: 75%;
        padding: 14px 16px;
        border-radius: 16px;
        box-shadow: var(--shadow);
      }

      .user .bubble {
        background: var(--accent);
        color: white;
        border-bottom-right-radius: 6px;
      }

      .assistant .bubble {
        background: var(--panel);
        border: 1px solid var(--border);
        border-bottom-left-radius: 6px;
      }

      .tool .bubble {
        background: var(--panel-2);
        border: 1px dashed var(--border);
        color: var(--muted);
      }

      .message-actions {
        display: flex;
        gap: 8px;
        align-items: center;
        font-size: 0.75rem;
        color: var(--muted);
      }

      .copy-btn {
        border: 1px solid var(--border);
        background: transparent;
        border-radius: 8px;
        padding: 4px 8px;
        cursor: pointer;
        color: var(--muted);
      }

      .run-trace {
        margin-top: 8px;
        border: 1px solid var(--border);
        background: var(--panel-2);
        border-radius: 12px;
        padding: 10px 12px;
      }

      .run-trace summary {
        cursor: pointer;
        font-weight: 600;
      }

      .run-step {
        font-size: 0.85rem;
        padding: 6px 0;
        border-bottom: 1px solid var(--border);
      }

      .run-step:last-child {
        border-bottom: none;
      }

      .composer {
        position: sticky;
        bottom: 0;
        background: var(--panel);
        border-top: 1px solid var(--border);
        padding: 16px 20px;
        display: flex;
        gap: 12px;
        align-items: flex-end;
      }

      .composer textarea {
        flex: 1;
        resize: none;
        border: 1px solid var(--border);
        border-radius: 14px;
        padding: 12px 14px;
        font-family: inherit;
        font-size: 0.95rem;
        background: var(--panel-2);
        color: var(--text);
        box-shadow: var(--shadow);
        min-height: 44px;
        max-height: 160px;
        overflow-y: auto;
      }

      .composer button {
        border: none;
        border-radius: 12px;
        padding: 12px 16px;
        font-weight: 600;
        cursor: pointer;
        background: var(--accent);
        color: white;
        box-shadow: var(--shadow);
        min-width: 90px;
      }

      .composer button[disabled] {
        opacity: 0.5;
        cursor: not-allowed;
      }

      .jump-latest {
        position: absolute;
        bottom: 92px;
        right: 24px;
        background: var(--panel);
        border: 1px solid var(--border);
        border-radius: 999px;
        padding: 8px 14px;
        box-shadow: var(--shadow);
        cursor: pointer;
      }

      .sidebar-toggle-mobile {
        display: none;
      }

      .drawer-backdrop {
        display: none;
      }

      @media (max-width: 900px) {
        .sidebar {
          position: fixed;
          left: 0;
          top: 0;
          bottom: 0;
          z-index: 20;
          transform: translateX(-100%);
        }

        .sidebar.open {
          transform: translateX(0);
        }

        .drawer-backdrop {
          display: block;
          position: fixed;
          inset: 0;
          background: rgba(0, 0, 0, 0.4);
          opacity: 0;
          pointer-events: none;
          transition: opacity 0.2s ease;
          z-index: 10;
        }

        .drawer-backdrop.active {
          opacity: 1;
          pointer-events: auto;
        }

        .sidebar-toggle-mobile {
          display: inline-flex;
        }
      }
    </style>
  </head>
  <body>
    <nav style="display:flex;gap:12px;padding:12px 16px;border-bottom:1px solid #d6dbe6;background:#ffffff;">
      <a href="/index.html">Home</a>
      <a href="/prototype-1.html">Prototype 1</a>
      <a href="/prototype-2.html">Prototype 2</a>
      <a href="/prototype-3.html">Prototype 3</a>
    </nav>

        <div id="app"></div>

    <script>
      const state = {
        theme: "light",
        sidebarCollapsed: false,
        sidebarOpenMobile: false,
        conversations: [],
        activeConversationId: "",
        streaming: { active: false, cancelToken: null },
      };

      const STORAGE_KEY = "prototype-1-chat-state";

      const saveStateToLocalStorage = () => {
        const payload = {
          theme: state.theme,
          sidebarCollapsed: state.sidebarCollapsed,
          sidebarOpenMobile: state.sidebarOpenMobile,
          conversations: state.conversations,
          activeConversationId: state.activeConversationId,
        };
        localStorage.setItem(STORAGE_KEY, JSON.stringify(payload));
      };

      const loadStateFromLocalStorage = () => {
        const stored = localStorage.getItem(STORAGE_KEY);
        if (!stored) return;
        try {
          const parsed = JSON.parse(stored);
          state.theme = parsed.theme || "light";
          state.sidebarCollapsed = Boolean(parsed.sidebarCollapsed);
          state.sidebarOpenMobile = Boolean(parsed.sidebarOpenMobile);
          state.conversations = Array.isArray(parsed.conversations)
            ? parsed.conversations
            : [];
          state.activeConversationId = parsed.activeConversationId || "";
        } catch (err) {
          console.warn("Failed to load state", err);
        }
      };

      const createConversation = () => {
        const id = "convo_" + Date.now().toString(36);
        const convo = {
          id,
          title: "New chat",
          updatedAt: Date.now(),
          messages: [],
        };
        state.conversations.unshift(convo);
        state.activeConversationId = id;
        saveStateToLocalStorage();
        return convo;
      };

      const renameConversation = (id) => {
        const convo = state.conversations.find((c) => c.id === id);
        if (!convo) return;
        const nextTitle = prompt("Rename conversation", convo.title);
        if (!nextTitle) return;
        convo.title = nextTitle.trim().slice(0, 60);
        convo.updatedAt = Date.now();
        saveStateToLocalStorage();
      };

      const deleteConversation = (id) => {
        const index = state.conversations.findIndex((c) => c.id === id);
        if (index === -1) return;
        const ok = confirm("Delete this conversation?");
        if (!ok) return;
        state.conversations.splice(index, 1);
        if (state.activeConversationId === id) {
          state.activeConversationId = state.conversations[0]?.id || "";
        }
        saveStateToLocalStorage();
      };

      const addMessage = (convoId, role, content, meta) => {
        const convo = state.conversations.find((c) => c.id === convoId);
        if (!convo) return;
        convo.messages.push({
          id: "msg_" + Date.now().toString(36) + Math.random().toString(36),
          role,
          content,
          createdAt: Date.now(),
          meta: meta || null,
        });
        convo.updatedAt = Date.now();
        saveStateToLocalStorage();
      };

      const mockGenerateResponse = (userText) => {
        const baseReplies = [
          "I reviewed the indicators and found a few possible pivots.",
          "Here's a quick assessment of the telemetry you shared.",
          "I ran a lightweight enrichment pass on the sample.",
        ];

        const iocSnippets = [
          "Extracted IOCs: 1.2.3.4, evil-domain.com, hash: e3b0c442...",
          "Extracted IOCs: 5.6.7.8, suspicious-login.net, hash: 2cf24dba...",
        ];

        const confidence = ["Confidence: medium.", "Confidence: high."];

        const nextSteps =
          "Recommended next steps:\n- Enrich domains with passive DNS\n- Check endpoint telemetry for matching hashes\n- Share with IR team";

        const includeTool = Math.random() > 0.6;
        const includeTrace = Math.random() > 0.5;

        const responseText =
          baseReplies[Math.floor(Math.random() * baseReplies.length)] +
          "\n\n" +
          iocSnippets[Math.floor(Math.random() * iocSnippets.length)] +
          "\n" +
          confidence[Math.floor(Math.random() * confidence.length)] +
          "\n\n" +
          nextSteps;

        const toolText = includeTool
          ? "Tool output: Extracted IOCs, normalized 3 indicators, 2 matches found."
          : null;

        const runTrace = includeTrace
          ? {
              steps: [
                {
                  name: "Collection",
                  duration: "0.6s",
                  logs: ["Pulled telemetry bundle", "Parsed 12 events"],
                },
                {
                  name: "Normalize",
                  duration: "0.4s",
                  logs: ["Normalized IPs", "Validated hashes"],
                },
                {
                  name: "Analyze",
                  duration: "1.1s",
                  logs: ["Matched against watchlist", "Risk scored"],
                },
                {
                  name: "Review",
                  duration: "0.5s",
                  logs: ["Flagged 2 indicators", "Prepared summary"],
                },
              ],
            }
          : null;

        return { text: responseText, toolText, runTrace };
      };

      const streamAssistantMessage = (fullText, onChunk, onDone, cancelToken) => {
        let index = 0;
        const interval = setInterval(() => {
          if (cancelToken.cancelled) {
            clearInterval(interval);
            onDone(true);
            return;
          }
          index += Math.floor(Math.random() * 5) + 2;
          const chunk = fullText.slice(0, index);
          onChunk(chunk);
          if (index >= fullText.length) {
            clearInterval(interval);
            onDone(false);
          }
        }, 45);
      };

      const formatTime = (timestamp) => {
        const date = new Date(timestamp);
        return date.toLocaleTimeString([], { hour: "2-digit", minute: "2-digit" });
      };

      const getActiveConversation = () =>
        state.conversations.find((c) => c.id === state.activeConversationId);

      const ensureActiveConversation = () => {
        if (!state.conversations.length) {
          createConversation();
        }
        if (!state.activeConversationId) {
          state.activeConversationId = state.conversations[0].id;
        }
      };

      const renderMessage = (message) => {
        const safeContent = message.content
          .split("\n")
          .map((line) => `<div>${line}</div>`)
          .join("");

        const copyButton =
          message.role === "assistant"
            ? `<button class="copy-btn" data-action="copy" data-id="${message.id}">? Copy</button>`
            : "";

        const runTrace =
          message.meta && message.meta.runTrace
            ? `<details class="run-trace"><summary>Run details</summary>${message.meta.runTrace.steps
                .map(
                  (step) =>
                    `<div class="run-step"><strong>${step.name}</strong> · ${step.duration}<br/>${step.logs
                      .map((log) => `<span>• ${log}</span>`)
                      .join("<br/>")}</div>`
                )
                .join("")}</details>`
            : "";

        return `
          <div class="message ${message.role}">
            <div class="bubble">${safeContent}</div>
            <div class="message-actions">
              <span>${formatTime(message.createdAt)}</span>
              ${copyButton}
            </div>
            ${runTrace}
          </div>
        `;
      };

      const render = () => {
        ensureActiveConversation();
        document.documentElement.setAttribute("data-theme", state.theme);

        const activeConversation = getActiveConversation();
        const query = state.searchQuery || "";
        const filtered = state.conversations.filter((c) =>
          c.title.toLowerCase().includes(query.toLowerCase())
        );

        const app = document.getElementById("app");
        app.innerHTML = `
          <div class="drawer-backdrop ${state.sidebarOpenMobile ? "active" : ""}" data-action="close-drawer"></div>
          <div class="app-shell app">
            <aside class="sidebar ${state.sidebarCollapsed ? "collapsed" : ""} ${state.sidebarOpenMobile ? "open" : ""}">
              <div class="sidebar-header">
                <button class="icon-btn" data-action="toggle-collapse">?</button>
                <button class="icon-btn" data-action="toggle-theme">${state.theme === "light" ? "??" : "?"}</button>
              </div>
              <div class="sidebar-body">
                <button class="new-chat" data-action="new-chat">+ New Chat</button>
                <label class="search">
                  ??
                  <input type="text" placeholder="Search" value="${query}" data-action="search" />
                </label>
                <div class="conversation-list">
                  ${filtered
                    .map(
                      (convo) => `
                      <div class="conversation-item ${
                        convo.id === state.activeConversationId ? "active" : ""
                      }" data-action="open" data-id="${convo.id}">
                        <div>
                          <div class="conversation-title">${convo.title}</div>
                          <div class="conversation-meta">${new Date(
                            convo.updatedAt
                          ).toLocaleDateString()}</div>
                        </div>
                        <div class="conversation-actions">
                          <button class="icon-only" title="Rename" data-action="rename" data-id="${convo.id}">?</button>
                          <button class="icon-only" title="Delete" data-action="delete" data-id="${convo.id}">??</button>
                        </div>
                      </div>
                    `
                    )
                    .join("")}
                </div>
              </div>
            </aside>

            <main class="main">
              <div class="topbar">
                <div class="topbar-actions">
                  <button class="sidebar-toggle-mobile" data-action="open-drawer">?</button>
                  <div class="title">${activeConversation?.title || "Conversation"}</div>
                </div>
                <div class="topbar-actions">
                  <button data-action="clear-chat">? Clear</button>
                </div>
              </div>

              <div class="chat-log" id="chat-log">
                ${activeConversation?.messages.map(renderMessage).join("") || ""}
              </div>

              <button class="jump-latest" style="display: none" data-action="jump">Jump to latest</button>

              <div class="composer">
                <textarea
                  id="composer"
                  rows="1"
                  placeholder="Message Prototype 1..."
                ></textarea>
                <button id="send-btn" ${state.streaming.active ? "" : "disabled"} data-action="send">${
                  state.streaming.active ? "Stop" : "Send"
                }</button>
              </div>
            </main>
          </div>
        `;

        const textarea = document.getElementById("composer");
        const sendBtn = document.getElementById("send-btn");
        const chatLog = document.getElementById("chat-log");
        const jumpBtn = document.querySelector(".jump-latest");

        const updateSendState = () => {
          if (!state.streaming.active) {
            sendBtn.disabled = textarea.value.trim().length === 0;
          }
        };

        const autoGrow = () => {
          textarea.style.height = "auto";
          textarea.style.height = Math.min(textarea.scrollHeight, 160) + "px";
          updateSendState();
        };

        textarea.addEventListener("input", autoGrow);
        autoGrow();

        const handleScroll = () => {
          const nearBottom =
            chatLog.scrollHeight - chatLog.scrollTop - chatLog.clientHeight < 120;
          jumpBtn.style.display = nearBottom ? "none" : "inline-flex";
        };

        chatLog.addEventListener("scroll", handleScroll);
        handleScroll();

        const scrollToBottom = () => {
          chatLog.scrollTop = chatLog.scrollHeight;
        };

        if (!state.preventAutoScroll) {
          scrollToBottom();
        }
      };

      const sendMessage = () => {
        const textarea = document.getElementById("composer");
        const text = textarea.value.trim();
        if (!text || state.streaming.active) return;

        const activeId = state.activeConversationId;
        addMessage(activeId, "user", text);
        textarea.value = "";
        state.preventAutoScroll = false;
        render();

        const response = mockGenerateResponse(text);
        if (response.toolText) {
          addMessage(activeId, "tool", response.toolText);
        }

        const assistantMessage = {
          id: "msg_" + Date.now().toString(36),
          role: "assistant",
          content: "",
          createdAt: Date.now(),
          meta: response.runTrace ? { runTrace: response.runTrace } : null,
        };

        const convo = getActiveConversation();
        convo.messages.push(assistantMessage);

        state.streaming.active = true;
        state.streaming.cancelToken = { cancelled: false };
        saveStateToLocalStorage();
        render();

        streamAssistantMessage(
          response.text,
          (chunk) => {
            assistantMessage.content = chunk;
            const chatLog = document.getElementById("chat-log");
            const nearBottom =
              chatLog.scrollHeight - chatLog.scrollTop - chatLog.clientHeight < 140;
            state.preventAutoScroll = !nearBottom;
            render();
          },
          (cancelled) => {
            state.streaming.active = false;
            if (cancelled) {
              assistantMessage.content += "\n\n[Response cancelled]";
            }
            saveStateToLocalStorage();
            render();
          },
          state.streaming.cancelToken
        );
      };

      const clearChat = () => {
        const convo = getActiveConversation();
        if (!convo) return;
        const ok = confirm("Clear this chat?");
        if (!ok) return;
        convo.messages = [];
        convo.updatedAt = Date.now();
        saveStateToLocalStorage();
        render();
      };

      const handleClick = (event) => {
        const actionEl = event.target.closest("[data-action]");
        if (!actionEl) return;
        const action = actionEl.dataset.action;
        const id = actionEl.dataset.id;

        if (action === "toggle-collapse") {
          state.sidebarCollapsed = !state.sidebarCollapsed;
          saveStateToLocalStorage();
          render();
          return;
        }

        if (action === "toggle-theme") {
          state.theme = state.theme === "light" ? "dark" : "light";
          saveStateToLocalStorage();
          render();
          return;
        }

        if (action === "new-chat") {
          createConversation();
          render();
          return;
        }

        if (action === "open" && id) {
          state.activeConversationId = id;
          state.sidebarOpenMobile = false;
          saveStateToLocalStorage();
          render();
          return;
        }

        if (action === "rename" && id) {
          renameConversation(id);
          render();
          return;
        }

        if (action === "delete" && id) {
          deleteConversation(id);
          render();
          return;
        }

        if (action === "send") {
          if (state.streaming.active) {
            if (state.streaming.cancelToken) {
              state.streaming.cancelToken.cancelled = true;
            }
          } else {
            sendMessage();
          }
          return;
        }

        if (action === "copy" && id) {
          const convo = getActiveConversation();
          const msg = convo?.messages.find((m) => m.id === id);
          if (msg) {
            navigator.clipboard.writeText(msg.content || "");
          }
          return;
        }

        if (action === "clear-chat") {
          clearChat();
          return;
        }

        if (action === "open-drawer") {
          state.sidebarOpenMobile = true;
          render();
          return;
        }

        if (action === "close-drawer") {
          state.sidebarOpenMobile = false;
          render();
          return;
        }

        if (action === "jump") {
          const chatLog = document.getElementById("chat-log");
          chatLog.scrollTop = chatLog.scrollHeight;
          return;
        }
      };

      const handleInput = (event) => {
        if (event.target.matches("[data-action='search']")) {
          state.searchQuery = event.target.value;
          render();
        }
      };

      const handleKeydown = (event) => {
        const textarea = event.target.closest("#composer");
        if (!textarea) return;
        if (event.key === "Enter" && !event.shiftKey) {
          event.preventDefault();
          sendMessage();
        }
      };

      loadStateFromLocalStorage();
      ensureActiveConversation();
      if (!state.conversations.length) {
        const convo = createConversation();
        addMessage(
          convo.id,
          "assistant",
          "Welcome to the Prototype 1 chat UI. Ask me about your threat intel case!"
        );
      }

      document.addEventListener("click", handleClick);
      document.addEventListener("input", handleInput);
      document.addEventListener("keydown", handleKeydown);

      render();
    </script>
  </body>
</html>