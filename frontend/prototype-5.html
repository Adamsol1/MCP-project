<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Prototype 5 - Analyst Workspace</title>
    <style>
      :root {
        color-scheme: light;
        --bg: #f0f4fa;
        --panel: #ffffff;
        --panel-2: #e8eef7;
        --panel-3: #dce4f2;
        --border: #c5d0e6;
        --text: #1a2340;
        --muted: #6b7a96;
        --shadow: 0 8px 24px rgba(20, 35, 75, 0.08);
        --shadow-lg: 0 16px 40px rgba(20, 35, 75, 0.12);
        --accent: #2563eb;
        --accent-light: #dbeafe;
        --accent-hover: #1d4ed8;
        --accent-subtle: #eff6ff;
        --success: #059669;
        --success-light: #d1fae5;
        --warn: #d97706;
        --warn-light: #fef3c7;
        --danger: #dc2626;
        --danger-light: #fee2e2;
        --radius: 14px;
        --radius-sm: 10px;
        --radius-xs: 8px;
      }

      [data-theme="dark"] {
        color-scheme: dark;
        --bg: #0b1120;
        --panel: #111b2e;
        --panel-2: #172340;
        --panel-3: #1e2d50;
        --border: #263a5e;
        --text: #e1e8f5;
        --muted: #8899b8;
        --shadow: 0 8px 24px rgba(0, 0, 0, 0.3);
        --shadow-lg: 0 16px 40px rgba(0, 0, 0, 0.4);
        --accent: #60a5fa;
        --accent-light: #1e3a5f;
        --accent-hover: #93c5fd;
        --accent-subtle: #0f2340;
        --success: #34d399;
        --success-light: #0d3024;
        --warn: #fbbf24;
        --warn-light: #3d2d05;
        --danger: #f87171;
        --danger-light: #3b1515;
      }

      * { box-sizing: border-box; margin: 0; }

      body {
        font-family: "Segoe UI", -apple-system, BlinkMacSystemFont, sans-serif;
        background: var(--bg);
        color: var(--text);
        height: 100vh;
        overflow: hidden;
        display: flex;
        flex-direction: column;
      }
      #app {
        flex: 1;
        min-height: 0;
        display: flex;
      }

      /* ---- Top Nav (prototype navigation) ---- */
      .proto-nav {
        display: flex;
        gap: 12px;
        padding: 10px 20px;
        border-bottom: 1px solid var(--border);
        background: var(--panel);
        font-size: 0.85rem;
        flex-shrink: 0;
      }
      .proto-nav a {
        color: var(--muted);
        text-decoration: none;
        padding: 4px 8px;
        border-radius: var(--radius-xs);
        transition: all 0.15s;
      }
      .proto-nav a:hover { color: var(--accent); background: var(--accent-subtle); }
      .proto-nav a.active { color: var(--accent); font-weight: 600; background: var(--accent-light); }

      /* ---- App Shell ---- */
      .app-shell {
        display: flex;
        flex: 1;
        min-height: 0;
      }

      /* ---- Sidebar ---- */
      .sidebar {
        width: 270px;
        min-width: 270px;
        background: var(--panel);
        border-right: 1px solid var(--border);
        display: flex;
        flex-direction: column;
        transition: all 0.25s ease;
        flex-shrink: 0;
      }
      .sidebar.collapsed { width: 0; min-width: 0; overflow: hidden; border-right: none; }

      .sidebar-head {
        padding: 16px;
        border-bottom: 1px solid var(--border);
        display: flex;
        flex-direction: column;
        gap: 12px;
      }
      .sidebar-brand {
        display: flex;
        align-items: center;
        gap: 10px;
      }
      .sidebar-brand .logo {
        width: 36px; height: 36px;
        background: linear-gradient(135deg, var(--accent), #7c3aed);
        border-radius: var(--radius-sm);
        display: flex; align-items: center; justify-content: center;
        color: white; font-weight: 800; font-size: 0.85rem;
      }
      .sidebar-brand .brand-text {
        font-weight: 700; font-size: 1rem; letter-spacing: -0.3px;
      }
      .sidebar-brand .brand-sub {
        font-size: 0.7rem; color: var(--muted); text-transform: uppercase; letter-spacing: 0.8px;
      }

      .btn-new-session {
        display: flex; align-items: center; justify-content: center; gap: 8px;
        padding: 10px; border-radius: var(--radius-sm);
        border: none; background: var(--accent); color: white;
        font-weight: 600; font-size: 0.88rem; cursor: pointer;
        box-shadow: 0 2px 8px rgba(37, 99, 235, 0.3);
        transition: all 0.15s;
      }
      .btn-new-session:hover { background: var(--accent-hover); }

      .sidebar-search {
        display: flex; align-items: center; gap: 6px;
        background: var(--panel-2); border: 1px solid var(--border);
        border-radius: var(--radius-sm); padding: 8px 10px;
      }
      .sidebar-search svg { color: var(--muted); flex-shrink: 0; }
      .sidebar-search input {
        background: transparent; border: none; outline: none;
        color: var(--text); width: 100%; font-size: 0.88rem;
      }

      .conversation-list {
        flex: 1; overflow-y: auto; padding: 10px 12px;
        display: flex; flex-direction: column; gap: 6px;
      }

      .convo-item {
        padding: 10px 12px; border-radius: var(--radius-sm);
        border: 1px solid transparent; background: var(--panel-2);
        cursor: pointer; display: flex; align-items: center;
        justify-content: space-between; gap: 8px;
        transition: all 0.15s;
      }
      .convo-item:hover { background: var(--accent-subtle); }
      .convo-item.active {
        border-color: var(--accent); background: var(--accent-light);
      }
      .convo-title { font-weight: 600; font-size: 0.9rem; }
      .convo-meta { font-size: 0.72rem; color: var(--muted); margin-top: 2px; }
      .convo-actions { display: flex; gap: 4px; }
      .convo-actions button {
        border: 1px solid var(--border); background: var(--panel);
        color: var(--muted); border-radius: 6px; width: 26px; height: 26px;
        display: inline-flex; align-items: center; justify-content: center;
        cursor: pointer; font-size: 0.72rem; transition: all 0.15s;
      }
      .convo-actions button:hover { color: var(--accent); border-color: var(--accent); }

      /* ---- Main Content ---- */
      .main-content {
        flex: 1; display: flex; flex-direction: column;
        min-width: 0; position: relative;
      }

      /* ---- Top Bar ---- */
      .topbar {
        display: flex; align-items: center; justify-content: space-between;
        padding: 12px 20px;
        border-bottom: 1px solid var(--border);
        background: var(--panel);
        flex-shrink: 0;
      }
      .topbar-left { display: flex; align-items: center; gap: 12px; }
      .topbar-title { font-weight: 700; font-size: 1.05rem; }
      .topbar-status {
        display: inline-flex; align-items: center; gap: 6px;
        font-size: 0.75rem; color: var(--muted);
        padding: 4px 10px; border-radius: 999px;
        background: var(--panel-2); border: 1px solid var(--border);
      }
      .topbar-status .dot {
        width: 6px; height: 6px; border-radius: 50%;
        background: var(--success); animation: pulse 2s infinite;
      }
      @keyframes pulse {
        0%, 100% { opacity: 1; }
        50% { opacity: 0.4; }
      }
      .topbar-right { display: flex; align-items: center; gap: 8px; }

      .btn-icon {
        border: 1px solid var(--border); background: var(--panel-2);
        padding: 8px 10px; border-radius: var(--radius-xs);
        cursor: pointer; color: var(--text); font-size: 0.82rem;
        transition: all 0.15s;
      }
      .btn-icon:hover { border-color: var(--accent); color: var(--accent); }

      /* ---- Middle Area (Chat + Intel Panel) ---- */
      .workspace {
        display: flex; flex: 1; min-height: 0;
      }

      /* ---- Chat Area ---- */
      .chat-area {
        flex: 1; display: flex; flex-direction: column; min-width: 0;
        position: relative;
      }

      /* ---- Control Strip ---- */
      .control-strip {
        display: flex; align-items: center; gap: 10px;
        padding: 10px 20px;
        border-bottom: 1px solid var(--border);
        background: var(--accent-subtle);
        flex-wrap: wrap;
        flex-shrink: 0;
      }
      .cs-group {
        display: flex; align-items: center; gap: 6px;
        font-size: 0.8rem;
      }
      .cs-label {
        font-size: 0.7rem; text-transform: uppercase;
        letter-spacing: 0.06em; color: var(--muted); font-weight: 600;
      }
      .cs-select, .cs-input {
        border: 1px solid var(--border); border-radius: var(--radius-xs);
        padding: 5px 8px; background: var(--panel); color: var(--text);
        font-size: 0.82rem;
      }
      .cs-stepper {
        display: inline-flex; align-items: center; gap: 4px;
      }
      .cs-stepper button {
        width: 24px; height: 24px; border-radius: 6px;
        border: 1px solid var(--border); background: var(--panel);
        cursor: pointer; color: var(--text); font-weight: 600;
      }
      .cs-stepper span { min-width: 18px; text-align: center; font-weight: 600; }
      .cs-divider {
        width: 1px; height: 24px; background: var(--border); margin: 0 4px;
      }
      .btn-upload, .btn-run {
        border: none; border-radius: var(--radius-xs);
        padding: 6px 12px; font-weight: 600; font-size: 0.8rem;
        cursor: pointer; transition: all 0.15s;
      }
      .btn-upload {
        background: var(--panel); border: 1px solid var(--border); color: var(--text);
      }
      .btn-upload:hover { border-color: var(--accent); color: var(--accent); }
      .btn-run {
        background: var(--accent); color: white;
        box-shadow: 0 2px 6px rgba(37, 99, 235, 0.25);
      }
      .btn-run:hover { background: var(--accent-hover); }

      /* ---- Direction Phase (Mock) ---- */
      .onboarding-panel {
        margin: 12px 20px 0;
        background: linear-gradient(135deg, var(--panel), var(--panel-2));
        border: 1px solid var(--border);
        border-radius: var(--radius);
        padding: 16px;
        box-shadow: var(--shadow);
        display: flex;
        flex-direction: column;
        gap: 12px;
      }
      .ti-stage {
        border: 1px solid var(--border);
        border-radius: var(--radius-sm);
        background: var(--panel);
        overflow: hidden;
      }
      .ti-stage-header {
        display: flex;
        align-items: center;
        justify-content: space-between;
        gap: 12px;
        padding: 10px 12px;
        background: var(--panel-2);
        cursor: pointer;
      }
      .ti-stage-title {
        font-weight: 700;
        font-size: 0.92rem;
      }
      .ti-stage-meta {
        font-size: 0.72rem;
        color: var(--muted);
        text-transform: uppercase;
        letter-spacing: 0.06em;
      }
      .ti-stage-body {
        padding: 12px;
        display: none;
      }
      .ti-stage.open .ti-stage-body { display: block; }
      .ti-stage-toggle {
        border: 1px solid var(--border);
        background: var(--panel);
        border-radius: 999px;
        padding: 4px 10px;
        font-size: 0.72rem;
        color: var(--muted);
      }
      .onb-header {
        display: flex;
        align-items: center;
        justify-content: space-between;
        gap: 12px;
      }
      .onb-title {
        font-weight: 700;
        font-size: 1rem;
      }
      .onb-sub {
        font-size: 0.78rem;
        color: var(--muted);
      }
      .onb-progress {
        font-size: 0.72rem;
        color: var(--muted);
        background: var(--panel-3);
        border: 1px solid var(--border);
        border-radius: 999px;
        padding: 4px 10px;
      }
      .onb-question {
        font-size: 0.95rem;
        font-weight: 600;
      }
      .onb-options {
        display: flex;
        flex-wrap: wrap;
        gap: 8px;
      }
      .onb-option {
        border: 1px solid var(--border);
        background: var(--panel);
        border-radius: 999px;
        padding: 6px 12px;
        font-size: 0.82rem;
        cursor: pointer;
        transition: all 0.15s;
      }
      .onb-option:hover { border-color: var(--accent); color: var(--accent); }
      .onb-option.active {
        border-color: var(--accent);
        background: var(--accent-light);
        color: var(--accent);
        font-weight: 600;
      }
      .ti-stage-status {
        display: inline-flex;
        align-items: center;
        gap: 6px;
        font-size: 0.72rem;
        color: var(--muted);
      }
      .ti-check {
        width: 14px;
        height: 14px;
        border-radius: 50%;
        background: var(--success);
        color: white;
        display: inline-flex;
        align-items: center;
        justify-content: center;
        font-size: 10px;
        font-weight: 700;
      }
      .action-buttons {
        display: inline-flex;
        gap: 8px;
        margin-top: 10px;
      }
      .action-buttons button {
        border: 1px solid var(--border);
        background: var(--panel);
        border-radius: 10px;
        padding: 6px 12px;
        font-size: 0.8rem;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.15s;
      }
      .action-buttons button.primary {
        background: var(--success);
        color: white;
        border-color: var(--success);
      }
      .ti-spinner {
        width: 14px;
        height: 14px;
        border-radius: 50%;
        border: 2px solid var(--border);
        border-top-color: var(--accent);
        animation: spin 0.9s linear infinite;
      }
      @keyframes spin {
        to { transform: rotate(360deg); }
      }
      .onb-actions {
        display: flex;
        flex-wrap: wrap;
        gap: 8px;
        align-items: center;
      }
      .onb-actions button {
        border: 1px solid var(--border);
        background: var(--panel);
        border-radius: 10px;
        padding: 8px 12px;
        font-size: 0.8rem;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.15s;
      }
      .onb-actions button.primary {
        background: var(--accent);
        color: white;
        border-color: var(--accent);
      }
      .onb-actions button.primary:hover { background: var(--accent-hover); }
      .onb-actions button.ghost {
        background: transparent;
      }
      .onb-summary {
        background: var(--panel);
        border: 1px dashed var(--border);
        border-radius: var(--radius-sm);
        padding: 10px 12px;
        font-size: 0.85rem;
      }
      .onb-kicker {
        font-size: 0.72rem;
        text-transform: uppercase;
        letter-spacing: 0.08em;
        color: var(--muted);
        margin-bottom: 6px;
      }

      /* ---- Progress ---- */
      .progress-bar {
        display: none; align-items: center; gap: 12px;
        padding: 8px 20px; background: var(--accent-subtle);
        border-bottom: 1px solid var(--border); flex-shrink: 0;
      }
      .progress-bar.active { display: flex; }
      .progress-track {
        flex: 1; height: 6px; background: var(--panel-3);
        border-radius: 999px; overflow: hidden;
      }
      .progress-fill {
        height: 100%; width: 0;
        background: linear-gradient(90deg, var(--accent), #7c3aed);
        border-radius: 999px; transition: width 0.25s ease;
      }
      .progress-label {
        font-size: 0.78rem; color: var(--muted); min-width: 120px;
      }
      .progress-bar .btn-cancel {
        border: 1px solid var(--border); background: var(--panel);
        border-radius: var(--radius-xs); padding: 4px 10px;
        cursor: pointer; font-size: 0.78rem; color: var(--muted);
      }

      /* ---- File chips ---- */
      .file-chips {
        display: flex; flex-wrap: wrap; gap: 6px;
        padding: 6px 20px; border-bottom: 1px solid var(--border);
        background: var(--panel); flex-shrink: 0;
      }
      .file-chips:empty { display: none; }
      .chip {
        background: var(--accent-light); border: 1px solid var(--accent);
        border-radius: 999px; padding: 3px 10px 3px 10px;
        font-size: 0.75rem; display: inline-flex; align-items: center; gap: 6px;
        color: var(--accent);
      }
      .chip button {
        border: none; background: transparent; cursor: pointer;
        color: var(--accent); font-size: 0.8rem; padding: 0; line-height: 1;
      }

      /* ---- Chat Log ---- */
      .chat-log {
        flex: 1; overflow-y: auto; padding: 24px 20px 24px;
        display: flex; flex-direction: column; gap: 16px;
        min-height: 0;
      }

      .message { display: flex; flex-direction: column; gap: 6px; }
      .message.user { align-items: flex-end; }
      .message.assistant { align-items: flex-start; }
      .message.tool { align-items: stretch; }

      .bubble {
        max-width: 86%; padding: 18px 22px; border-radius: 18px;
        line-height: 1.6; box-shadow: var(--shadow);
        font-size: 0.98rem;
      }
      .assistant .bubble {
        background: linear-gradient(180deg, var(--panel), var(--panel-2));
      }
      .bubble .section-title {
        font-weight: 700;
        margin-top: 8px;
      }
      .bubble .subtle {
        color: var(--muted);
        font-size: 0.86rem;
      }
      .bubble .list {
        display: grid;
        gap: 4px;
        margin: 4px 0 8px;
      }
      .bubble .card {
        border: 1px solid var(--border);
        background: var(--panel);
        border-radius: 12px;
        padding: 10px 12px;
        margin: 8px 0;
      }
      .bubble .pill {
        display: inline-block;
        padding: 2px 8px;
        border-radius: 999px;
        background: var(--accent-light);
        color: var(--accent);
        font-size: 0.72rem;
        font-weight: 700;
        text-transform: uppercase;
        letter-spacing: 0.06em;
      }
      .bubble .divider {
        height: 1px;
        background: var(--border);
        margin: 8px 0;
      }
      .user .bubble {
        background: linear-gradient(135deg, var(--accent), #4f46e5);
        color: white; border-bottom-right-radius: 6px;
      }
      .assistant .bubble {
        background: var(--panel); border: 1px solid var(--border);
        border-bottom-left-radius: 6px;
      }
      .tool .bubble {
        background: var(--panel-2); border: 1px dashed var(--border);
        color: var(--muted); font-size: 0.88rem;
        max-width: 100%; border-radius: var(--radius);
      }

      .msg-actions {
        display: flex; gap: 8px; align-items: center;
        font-size: 0.72rem; color: var(--muted);
      }
      .msg-actions button {
        border: 1px solid var(--border); background: transparent;
        border-radius: 6px; padding: 3px 8px; cursor: pointer;
        color: var(--muted); font-size: 0.72rem; transition: all 0.15s;
      }
      .msg-actions button:hover { color: var(--accent); border-color: var(--accent); }

      .run-trace {
        margin-top: 6px; border: 1px solid var(--border);
        background: var(--panel-2); border-radius: var(--radius-sm);
        padding: 8px 12px; max-width: 72%;
      }
      .run-trace summary { cursor: pointer; font-weight: 600; font-size: 0.85rem; }
      .run-step {
        font-size: 0.82rem; padding: 5px 0;
        border-bottom: 1px solid var(--border);
      }
      .run-step:last-child { border-bottom: none; }

      .artifacts { display: none; }

      /* ---- Composer ---- */
      .composer {
        background: var(--panel); border-top: 1px solid var(--border);
        padding: 14px 20px; display: flex; gap: 12px;
        align-items: flex-end; z-index: 5;
        box-shadow: 0 -4px 16px rgba(20, 35, 75, 0.06);
        flex-shrink: 0;
        margin-top: auto;
      }
      .composer textarea {
        flex: 1; resize: none; border: 1px solid var(--border);
        border-radius: 16px; padding: 12px 16px;
        font-family: inherit; font-size: 0.95rem;
        background: var(--panel-2); color: var(--text);
        min-height: 48px; max-height: 160px; overflow-y: auto;
        transition: border-color 0.15s;
      }
      .composer textarea:focus { outline: none; border-color: var(--accent); }
      .composer button {
        border: none; border-radius: 12px; padding: 12px 18px;
        font-weight: 600; cursor: pointer; background: var(--accent);
        color: white; min-width: 80px; font-size: 0.9rem;
        box-shadow: 0 2px 8px rgba(37, 99, 235, 0.3);
        transition: all 0.15s;
      }
      .composer button:hover { background: var(--accent-hover); }
      .composer button[disabled] { opacity: 0.45; cursor: not-allowed; }

      .jump-latest {
        position: absolute; bottom: 90px; right: 24px;
        background: var(--panel); border: 1px solid var(--border);
        border-radius: 999px; padding: 8px 14px;
        box-shadow: var(--shadow); cursor: pointer;
        font-size: 0.8rem; color: var(--muted);
        display: none; z-index: 6;
      }

      /* ---- Intel Panel (Right) ---- */
      .intel-panel {
        width: 320px; min-width: 320px;
        background: var(--panel); border-left: 1px solid var(--border);
        display: flex; flex-direction: column;
        transition: all 0.25s ease; flex-shrink: 0;
      }
      .intel-panel.collapsed { width: 0; min-width: 0; overflow: hidden; border-left: none; }

      .intel-tabs {
        display: flex; border-bottom: 1px solid var(--border);
        flex-shrink: 0;
      }
      .intel-tab {
        flex: 1; padding: 10px 8px; text-align: center;
        font-size: 0.78rem; font-weight: 600; text-transform: uppercase;
        letter-spacing: 0.04em; color: var(--muted);
        border: none; background: transparent; cursor: pointer;
        border-bottom: 2px solid transparent; transition: all 0.15s;
      }
      .intel-tab:hover { color: var(--text); }
      .intel-tab.active {
        color: var(--accent); border-bottom-color: var(--accent);
        background: var(--accent-subtle);
      }

      .intel-body {
        flex: 1; overflow-y: auto; padding: 14px;
        display: flex; flex-direction: column; gap: 12px;
      }

      /* Risk Gauge */
      .risk-gauge {
        background: var(--panel-2); border: 1px solid var(--border);
        border-radius: var(--radius); padding: 16px; text-align: center;
      }
      .risk-gauge .gauge-label {
        font-size: 0.72rem; text-transform: uppercase;
        letter-spacing: 0.08em; color: var(--muted); margin-bottom: 8px;
      }
      .risk-gauge .gauge-value {
        font-size: 2.2rem; font-weight: 800;
        background: linear-gradient(135deg, var(--accent), #7c3aed);
        -webkit-background-clip: text; -webkit-text-fill-color: transparent;
        background-clip: text;
      }
      .risk-gauge .gauge-bar {
        height: 8px; background: var(--panel-3); border-radius: 999px;
        overflow: hidden; margin-top: 8px;
      }
      .risk-gauge .gauge-fill {
        height: 100%; border-radius: 999px;
        transition: width 0.4s ease;
      }

      /* Metric Cards */
      .metric-row {
        display: grid; grid-template-columns: 1fr 1fr; gap: 8px;
      }
      .metric-card {
        background: var(--panel-2); border: 1px solid var(--border);
        border-radius: var(--radius-sm); padding: 12px;
      }
      .metric-card .mc-label {
        font-size: 0.7rem; text-transform: uppercase;
        letter-spacing: 0.06em; color: var(--muted); margin-bottom: 4px;
      }
      .metric-card .mc-value { font-size: 1.3rem; font-weight: 700; }

      /* IOC List */
      .ioc-section-header {
        display: flex; align-items: center; justify-content: space-between;
      }
      .ioc-section-header h4 {
        font-size: 0.78rem; text-transform: uppercase;
        letter-spacing: 0.06em; color: var(--muted);
      }
      .ioc-section-header button {
        border: 1px solid var(--border); background: var(--panel-2);
        border-radius: 6px; padding: 4px 8px; cursor: pointer;
        font-size: 0.72rem; color: var(--muted);
      }

      .ioc-list { display: flex; flex-direction: column; gap: 6px; }
      .ioc-item {
        display: flex; align-items: center; justify-content: space-between;
        padding: 8px 10px; background: var(--panel-2);
        border: 1px solid var(--border); border-radius: var(--radius-xs);
        font-size: 0.82rem;
      }
      .ioc-value { font-family: "Consolas", "Monaco", monospace; font-size: 0.8rem; }
      .ioc-badge {
        padding: 2px 8px; border-radius: 999px; font-size: 0.68rem;
        font-weight: 600; text-transform: uppercase; letter-spacing: 0.04em;
      }
      .ioc-badge.high { background: var(--danger-light); color: var(--danger); }
      .ioc-badge.medium { background: var(--warn-light); color: var(--warn); }
      .ioc-badge.low { background: var(--success-light); color: var(--success); }

      /* Settings Tab */
      .settings-group {
        background: var(--panel-2); border: 1px solid var(--border);
        border-radius: var(--radius-sm); padding: 12px;
        display: flex; flex-direction: column; gap: 8px;
      }
      .settings-group h4 {
        font-size: 0.72rem; text-transform: uppercase;
        letter-spacing: 0.06em; color: var(--muted); margin: 0;
      }
      .settings-row {
        display: flex; align-items: center; justify-content: space-between;
        gap: 8px;
      }
      .settings-row label { font-size: 0.82rem; color: var(--text); }
      .settings-row select, .settings-row input {
        border: 1px solid var(--border); border-radius: var(--radius-xs);
        padding: 5px 8px; background: var(--panel); color: var(--text);
        font-size: 0.82rem; max-width: 140px;
      }

      /* Download buttons in intel panel */
      .download-section {
        display: flex; flex-direction: column; gap: 6px; margin-top: auto;
        padding-top: 12px; border-top: 1px solid var(--border);
      }
      .btn-download {
        border: none; border-radius: var(--radius-xs);
        padding: 10px; font-weight: 600; cursor: pointer;
        font-size: 0.82rem; text-align: center;
        transition: all 0.15s;
      }
      .btn-download.primary {
        background: var(--accent); color: white;
        box-shadow: 0 2px 6px rgba(37, 99, 235, 0.25);
      }
      .btn-download.primary:hover { background: var(--accent-hover); }
      .btn-download.secondary {
        background: var(--panel-2); color: var(--text);
        border: 1px solid var(--border);
      }
      .btn-download.secondary:hover { border-color: var(--accent); color: var(--accent); }

      /* ---- Empty State ---- */
      .empty-state {
        display: flex; flex-direction: column; align-items: center;
        justify-content: center; flex: 1; gap: 12px; color: var(--muted);
        padding: 40px;
      }
      .empty-state .es-icon {
        width: 64px; height: 64px; border-radius: 50%;
        background: var(--accent-light); display: flex;
        align-items: center; justify-content: center;
        font-size: 1.5rem; color: var(--accent);
      }
      .empty-state h3 { font-size: 1.1rem; color: var(--text); }
      .empty-state p { font-size: 0.88rem; text-align: center; max-width: 300px; }

      /* ---- Mobile Drawer ---- */
      .drawer-backdrop {
        display: none; position: fixed; inset: 0;
        background: rgba(0, 0, 0, 0.4);
        opacity: 0; pointer-events: none;
        transition: opacity 0.2s ease; z-index: 10;
      }
      .drawer-backdrop.active { opacity: 1; pointer-events: auto; }

      .sidebar-toggle-mobile { display: none; }

      /* ---- Responsive ---- */
      @media (max-width: 1200px) {
        .intel-panel { width: 280px; min-width: 280px; }
      }

      @media (max-width: 1000px) {
        .intel-panel { width: 0; min-width: 0; overflow: hidden; border-left: none; }
      }

      @media (max-width: 800px) {
        .sidebar {
          position: fixed; left: 0; top: 0; bottom: 0;
          z-index: 20; transform: translateX(-100%);
          max-width: 300px; width: 300px;
        }
        .sidebar.open { transform: translateX(0); }
        .drawer-backdrop { display: block; }
        .sidebar-toggle-mobile { display: inline-flex; }
        .control-strip { padding: 8px 12px; }
      }

      /* ---- Scrollbar ---- */
      ::-webkit-scrollbar { width: 6px; }
      ::-webkit-scrollbar-track { background: transparent; }
      ::-webkit-scrollbar-thumb { background: var(--border); border-radius: 999px; }
      ::-webkit-scrollbar-thumb:hover { background: var(--muted); }

      /* ---- Focus ---- */
      *:focus-visible { outline: 2px solid var(--accent); outline-offset: 2px; }
    </style>
  </head>
  <body>
    <nav class="proto-nav">
      <a href="/index.html">Home</a>
      <a href="/prototype-1.html">Prototype 1</a>
      <a href="/prototype-2.html">Prototype 2</a>
      <a href="/prototype-3.html">Prototype 3</a>
      <a href="/prototype-4.html">Prototype 4</a>
      <a href="/prototype-5.html" class="active">Prototype 5</a>
    </nav>

    <div id="app"></div>

    <script>
      /* ===== State ===== */
      const state = {
        theme: "light",
        sidebarCollapsed: false,
        sidebarOpenMobile: false,
        intelPanelCollapsed: false,
        intelTab: "iocs",
        onboarding: {
          active: true,
          stepIndex: 0,
          askedIndex: -1,
          answers: {},
          multiSelections: [],
          currentStage: "direction",
          completedStages: {
            direction: false,
            planning: false,
            collection: false,
            processing: false,
            analysis: false,
          },
          stageOpen: {
            direction: true,
            planning: false,
            collection: false,
            processing: false,
            analysis: false,
          },
        },
        forceScrollToBottom: false,
        control: {
          aiRounds: 3,
          aiCountries: ["US", "UK"],
          modelPreset: "Balanced",
          modelCount: 2,
          language: "English",
          uploadedFiles: [],
        },
        conversations: [],
        activeConversationId: "",
        uploadPrompted: false,
        run: { active: false, cancelled: false, progress: 0, stage: "", cancelToken: null },
        intel: {
          risk: 42,
          iocs: [
            { value: "1.2.3.4", type: "ip", severity: "high" },
            { value: "evil-domain.com", type: "domain", severity: "medium" },
            { value: "e3b0c442...", type: "hash", severity: "low" },
          ],
        },
      };

      const onboardingScript = [
        {
          id: "user_prompt",
          section: "Opening",
          prompt: "Enter your instruction to begin.",
          allowFreeText: true,
        },
        {
          id: "prompt_reason",
          section: "Opening",
          prompt: "What prompted this investigation? Are you responding to an incident, preparing for a threat, or conducting routine intelligence gathering?",
          allowFreeText: true,
        },
        {
          id: "primary_focus",
          section: "Opening",
          prompt: "What is your primary focus?",
          allowFreeText: true,
        },
        {
          id: "timeframe",
          section: "Scope",
          prompt: "What timeframe are you interested in?",
          allowFreeText: true,
        },
        {
          id: "geography",
          section: "Scope",
          prompt: "What geographic perspective matters most?",
          allowFreeText: true,
        },
        {
          id: "key_aspects",
          section: "Scope",
          prompt: "What aspects are most important? (Select all that apply)",
          allowFreeText: true,
        },
        {
          id: "detail_level",
          section: "Depth",
          prompt: "What level of detail do you need?",
          allowFreeText: true,
        },
        {
          id: "attack_vectors",
          section: "Depth",
          prompt: "Are there specific attack vectors you're concerned about? (Select all that apply)",
          allowFreeText: true,
        },
        {
          id: "data_sources",
          section: "Collection",
          prompt: "Which data sources should I prioritize?",
          allowFreeText: true,
        },
        {
          id: "keywords",
          section: "Collection",
          prompt: "Are there specific indicators or keywords I should focus on?",
          allowFreeText: true,
        },
        {
          id: "confirm",
          section: "Validation",
          prompt: "Let me confirm your requirements. Is this correct, or would you like to adjust anything?",
          confirm: true,
          allowFreeText: true,
        },
      ];

      /* ===== Conversation CRUD ===== */
      const createConversation = () => {
        const id = "convo_" + Date.now().toString(36);
        const convo = { id, title: "New chat", updatedAt: Date.now(), messages: [] };
        state.conversations.unshift(convo);
        state.activeConversationId = id;
        state.uploadPrompted = false;
        resetOnboarding();
        return convo;
      };

      const renameConversation = (id) => {
        const convo = state.conversations.find((c) => c.id === id);
        if (!convo) return;
        const next = prompt("Rename conversation", convo.title);
        if (!next) return;
        convo.title = next.trim().slice(0, 60);
        convo.updatedAt = Date.now();
      };

      const deleteConversation = (id) => {
        const idx = state.conversations.findIndex((c) => c.id === id);
        if (idx === -1) return;
        if (!confirm("Delete this conversation?")) return;
        state.conversations.splice(idx, 1);
        if (state.activeConversationId === id) {
          state.activeConversationId = state.conversations[0]?.id || "";
        }
      };

      const addMessage = (convoId, role, content, meta) => {
        const convo = state.conversations.find((c) => c.id === convoId);
        if (!convo) return;
        convo.messages.push({
          id: "msg_" + Date.now().toString(36) + Math.random().toString(36),
          role, content, createdAt: Date.now(), meta: meta || null,
        });
        convo.updatedAt = Date.now();
      };

      const getActive = () => state.conversations.find((c) => c.id === state.activeConversationId);

      const ensureActive = () => {
        if (!state.conversations.length) createConversation();
        if (!state.activeConversationId) state.activeConversationId = state.conversations[0].id;
      };

      /* ===== Direction Phase (Mock) ===== */
      const getOnboardingStep = () => onboardingScript[state.onboarding.stepIndex];

      const buildSummary = () => {
        const ans = state.onboarding.answers;
        const fmt = (val) => {
          if (Array.isArray(val)) return val.length ? val.join(", ") : "Not specified";
          return val && String(val).trim() ? val : "Not specified";
        };
        return [
          `Threat focus: ${fmt(ans.primary_focus)}`,
          `Timeframe: ${fmt(ans.timeframe)}`,
          `Geographic scope: ${fmt(ans.geography)}`,
          `Key aspects: ${fmt(ans.key_aspects)}`,
          `Data sources: ${fmt(ans.data_sources)}`,
          `Indicators/keywords: ${fmt(ans.keywords)}`,
        ].join("\n");
      };

      const appendAssistant = (content) => {
        const convo = getActive();
        if (!convo) return;
        addMessage(convo.id, "assistant", content);
      };

      const appendUser = (content) => {
        const convo = getActive();
        if (!convo) return;
        addMessage(convo.id, "user", content);
      };

      const ensureOnboardingPrompt = () => {
        if (!state.onboarding.active) return;
        const step = getOnboardingStep();
        if (!step) return;
        if (state.onboarding.askedIndex === state.onboarding.stepIndex) return;
        appendAssistant(step.prompt);
        state.onboarding.askedIndex = state.onboarding.stepIndex;
      };

      function resetOnboarding() {
        state.onboarding.active = true;
        state.onboarding.stepIndex = 0;
        state.onboarding.askedIndex = -1;
        state.onboarding.answers = {};
        state.onboarding.multiSelections = [];
        state.onboarding.currentStage = "direction";
        state.onboarding.completedStages = {
          direction: false,
          planning: false,
          collection: false,
          processing: false,
          analysis: false,
        };
        state.onboarding.stageOpen = {
          direction: true,
          planning: false,
          collection: false,
          processing: false,
          analysis: false,
        };
      }

      const advanceOnboarding = () => {
        state.onboarding.stepIndex += 1;
        state.onboarding.multiSelections = [];
        if (state.onboarding.stepIndex >= onboardingScript.length) {
          completeOnboarding();
          return;
        }
        ensureOnboardingPrompt();
        render();
      };

      const backOnboarding = () => {
        state.onboarding.stepIndex = Math.max(0, state.onboarding.stepIndex - 1);
        state.onboarding.multiSelections = [];
        ensureOnboardingPrompt();
        render();
      };

      const completeOnboarding = () => {
        const summary = buildSummary();
        appendAssistant("Direction Phase Summary:\n" + summary);
        appendAssistant(
          "Priority Intelligence Requirements:\n" +
          "1. What TTPs has APT29 used in campaigns against Nordic countries in the last 6 months?\n" +
          "2. What infrastructure (domains, IPs) is associated with recent APT29 activity targeting government sectors?\n" +
          "3. What detection opportunities exist for APT29's documented TTPs?\n" +
          "4. What are the geopolitical motivations behind APT29's Nordic targeting?"
        );
        state.onboarding.active = false;
        render();
      };

      const recordAnswer = (value) => {
        const step = getOnboardingStep();
        if (!step) return;
        state.onboarding.answers[step.id] = value;
      };

      const commitFreeText = (text) => {
        const value = text && text.trim() ? text.trim() : "Not specified";
        recordAnswer(value);
        appendUser(value);
        advanceOnboarding();
      };

      /* ===== Mock Response Generator ===== */
      const mockResponse = (text, ctrl) => {
        const fileMention = ctrl.uploadedFiles.length
          ? `Parsed ${ctrl.uploadedFiles.length} file(s): ${ctrl.uploadedFiles.map((f) => f.name).join(", ")}.`
          : "No files attached. Analysis based on text input.";

        const iocs = [
          { type: "ip", value: "1.2.3.4", severity: "medium" },
          { type: "domain", value: "evil-domain.com", severity: "high" },
          { type: "hash", value: "e3b0c442...", severity: "low" },
        ];

        const steps = [
          { name: "Collection", duration: "0.6s" },
          { name: "Normalize", duration: "0.4s" },
          { name: "Analyze", duration: "1.1s" },
          { name: "Review", duration: "0.5s" },
        ];

        const body =
          `Assessment (${ctrl.modelPreset}, ${ctrl.modelCount} model(s)).\n${fileMention}` +
          "\n\nExtracted IOCs:\n" +
          iocs.map((i) => `- ${i.type}: ${i.value} (${i.severity})`).join("\n") +
          "\n\nRecommended next steps:\n- Enrich indicators with passive DNS\n- Correlate endpoint telemetry\n- Escalate to IR team";

        return { text: body, runTrace: { steps }, iocs };
      };

      /* ===== Streaming ===== */
      const streamText = (fullText, onChunk, onDone, cancelToken) => {
        let idx = 0;
        const iv = setInterval(() => {
          if (cancelToken.cancelled) { clearInterval(iv); onDone(true); return; }
          idx += Math.floor(Math.random() * 16) + 8;
          onChunk(fullText.slice(0, idx));
          if (idx >= fullText.length) { clearInterval(iv); onDone(false); }
        }, 18);
      };

      /* ===== Run ===== */
      const startRun = () => {
        if (state.run.active) return;
        state.run = { active: true, cancelled: false, progress: 0, stage: "Collecting...", cancelToken: { cancelled: false } };
        updateProgressUI();
        const stages = [
          { label: "Collecting...", until: 25 },
          { label: "Normalizing...", until: 50 },
          { label: "Analyzing...", until: 80 },
          { label: "Reviewing...", until: 100 },
        ];
        let si = 0;
        const iv = setInterval(() => {
          if (state.run.cancelToken?.cancelled) {
            clearInterval(iv);
            state.run = { active: false, cancelled: true, progress: 0, stage: "Cancelled", cancelToken: null };
            updateProgressUI(); return;
          }
          state.run.progress += Math.floor(Math.random() * 6) + 3;
          if (state.run.progress >= stages[si].until) si = Math.min(si + 1, stages.length - 1);
          state.run.stage = stages[si].label;
          if (state.run.progress >= 100) {
            state.run.progress = 100; state.run.active = false;
            state.run.stage = "Completed"; clearInterval(iv);
          }
          updateProgressUI();
        }, 220);
      };

      const startPhaseRun = (label, durationMs = 5000) => {
        if (state.run.active) return;
        const start = Date.now();
        state.run = { active: true, cancelled: false, progress: 0, stage: label, cancelToken: { cancelled: false } };
        updateProgressUI();
        const iv = setInterval(() => {
          const elapsed = Date.now() - start;
          const pct = Math.min(100, Math.round((elapsed / durationMs) * 100));
          state.run.progress = pct;
          if (pct >= 100) {
            clearInterval(iv);
            state.run.active = false;
            state.run.stage = "Completed";
          }
          updateProgressUI();
        }, 120);
      };

      /* ===== Helpers ===== */
      const fmtTime = (ts) => new Date(ts).toLocaleTimeString([], { hour: "2-digit", minute: "2-digit" });

      const riskColor = (r) => r >= 70 ? "var(--danger)" : r >= 40 ? "var(--warn)" : "var(--success)";

      const updateProgressUI = () => {
        const bar = document.querySelector(".progress-bar");
        const fill = document.querySelector(".progress-fill");
        const label = document.querySelector(".progress-label");
        if (bar) bar.classList.toggle("active", !!state.run.active);
        if (fill) fill.style.width = `${state.run.progress}%`;
        if (label) label.textContent = `${state.run.stage || ""} ${state.run.progress}%`;
        const sendBtn = document.getElementById("send-btn");
        const ta = document.getElementById("composer-input");
        if (sendBtn) {
          sendBtn.textContent = state.run.active ? "Stop" : "Send";
          if (state.run.active) sendBtn.disabled = false;
          else sendBtn.disabled = !ta || ta.value.trim().length === 0;
        }
      };

      /* ===== Downloads ===== */
      const dlBlob = (content, name, type) => {
        const a = document.createElement("a");
        a.href = URL.createObjectURL(new Blob([content], { type }));
        a.download = name; document.body.appendChild(a); a.click();
        a.remove(); URL.revokeObjectURL(a.href);
      };
      const dlReport = () => {
        const c = getActive();
        const lines = [`Conversation: ${c?.title}`, `Model: ${state.control.modelPreset}`, `Models: ${state.control.modelCount}`, "", "Messages:"];
        (c?.messages || []).forEach((m) => lines.push(`[${m.role}] ${m.content}`));
        dlBlob(lines.join("\n"), "report.txt", "text/plain");
      };
      const dlJson = () => {
        const c = getActive();
        dlBlob(JSON.stringify({ settings: state.control, messages: c?.messages || [], intel: state.intel }, null, 2), "analysis.json", "application/json");
      };

      /* ===== Send Message ===== */
      const sendMessage = () => {
        const ta = document.getElementById("composer-input");
        const text = ta.value.trim();
        if (!text || state.run.active) return;
        const aid = state.activeConversationId;
        const userMsgCount = getActive().messages.filter((m) => m.role === "user").length;
        const normalizedPrompt = "analyse the situation in greenland";
        const planningAnswer =
          "Responding to an incident. Focus: suspected APT29 activity. Timeframe: last 6 months. Geography: Nordic region. " +
          "Depth: operational intelligence for SOC/IR. Audience: SOC leadership and IR team. " +
          "Sources: OSINT feeds plus uploaded internal data. Constraints: rapid turnaround, TLP: AMBER.";
        const finalUserText = userMsgCount === 0 ? normalizedPrompt : userMsgCount === 1 ? planningAnswer : text;
        addMessage(aid, "user", finalUserText);
        ta.value = "";
        // Only force scroll to bottom if user was already at the bottom
        const cl = document.getElementById("chat-log");
        const nearBottom = cl ? cl.scrollHeight - cl.scrollTop - cl.clientHeight < 12 : true;
        state.forceScrollToBottom = nearBottom;
        render();

        if (!state.uploadPrompted && !state.control.uploadedFiles.length) {
          state.uploadPrompted = true;
        }

        startRun();

        if (state.control.uploadedFiles.length) {
          addMessage(aid, "tool", `Parsing ${state.control.uploadedFiles.length} file(s)... extracted ${state.control.uploadedFiles.length * 3} IOCs.`);
        }

        const nextUserCount = userMsgCount + 1;
        const isFirstUserMsg = nextUserCount === 1;
        const isSecondUserMsg = nextUserCount === 2;

        const directionExamplePlain =
          "Direction Phase Goals\n" +
          "Define intelligence requirements - What specific questions need answering?\n" +
          "Establish scope and priorities - What matters most and what's out of scope?\n" +
          "Identify stakeholders - Who needs this intelligence and why?\n" +
          "Set collection boundaries - What sources, timeframes, and constraints apply?\n" +
          "Align with organizational needs - How does this support business/security objectives?\n\n" +
          "Core Questions Analysts Ask Themselves\n\n" +
          "1. Threat Focus\n\n" +
          "What specific threat am I investigating?\n" +
          "Is this about a threat actor, campaign, vulnerability, or general threat landscape?\n" +
          "Do I need technical details (TTPs, IOCs) or strategic context (attribution, motivation)?\n\n" +
          "1. Scope Definition\n\n" +
          "What time period am I interested in? (Recent activity, historical analysis, ongoing monitoring)\n" +
          "What geographic regions matter? (Global, specific countries, our infrastructure locations)\n" +
          "What assets/systems am I trying to protect?\n" +
          "What attack vectors or techniques am I most concerned about?\n\n" +
          "1. Depth vs. Breadth\n\n" +
          "Do I need a comprehensive overview or deep-dive analysis?\n" +
          "Am I looking for specific indicators or broader patterns?\n" +
          "Is this for immediate response or strategic planning?\n\n" +
          "1. Audience & Use Case\n\n" +
          "Who will consume this intelligence? (Executive, SOC, IR team, threat hunting)\n" +
          "What decision needs to be made with this intelligence?\n" +
          "What level of technical detail is appropriate?\n\n" +
          "1. Collection Constraints\n\n" +
          "What data sources are available/preferred?\n" +
          "Are there time constraints?\n" +
          "Are there sensitivity/classification requirements?\n\n" +
          "Suggested AI Dialogue Questions\n" +
          "Based on your dialogue-based Direction phase, the AI should ask questions in a conversational flow that naturally narrows scope:\n\n" +
          "Opening Questions (Establish Context)\n" +
          "1. \"What prompted this investigation? Are you responding to an incident, preparing for a threat, or conducting routine intelligence gathering?\"\n" +
          "2. \"What is your primary focus?\"\n" +
          "- Specific threat actor (e.g., APT29, Lazarus Group)\n" +
          "- Threat campaign (e.g., ransomware wave, supply chain attacks)\n" +
          "- Vulnerability/exploit (e.g., zero-days, known CVEs)\n" +
          "- General threat landscape (e.g., threats to financial sector)\n\n" +
          "Scope Refinement Questions\n" +
          "3. \"What timeframe are you interested in?\"\n" +
          "- Last 24 hours (immediate threats)\n" +
          "- Last week/month (recent activity)\n" +
          "- Last 6-12 months (trend analysis)\n" +
          "- Historical (attribution, evolution)\n" +
          "4. \"What geographic perspective matters most?\"\n" +
          "- Global\n" +
          "- Specific regions (Nordic, Europe, Asia-Pacific, etc.)\n" +
          "- Threats targeting our specific location\n" +
          "5. \"What aspects are most important?\" (allow multiple)\n" +
          "- Technical indicators (IPs, domains, file hashes)\n" +
          "- Tactics, Techniques, and Procedures (TTPs)\n" +
          "- Attribution and motivation\n" +
          "- Target selection patterns\n" +
          "- Impact assessment\n\n" +
          "Technical Depth Questions\n" +
          "6. \"What level of detail do you need?\"\n" +
          "- Executive summary (strategic)\n" +
          "- Operational intelligence (for SOC/IR)\n" +
          "- Technical deep-dive (for threat hunting)\n" +
          "7. \"Are there specific attack vectors you're concerned about?\"\n" +
          "- Phishing/social engineering\n" +
          "- Network exploitation\n" +
          "- Supply chain compromise\n" +
          "- Insider threats\n" +
          "- etc.\n\n" +
          "Collection Planning Questions\n" +
          "8. \"Which data sources should I prioritize?\" (based on selected sources)\n" +
          "- OSINT feeds (OTX, MISP)\n" +
          "- Your uploaded data\n" +
          "- All available sources\n" +
          "9. \"Are there specific indicators or keywords I should focus on?\"\n" +
          "- Specific malware families\n" +
          "- Infrastructure patterns\n" +
          "- Target industries/organizations\n\n" +
          "Validation Questions\n" +
          "10. \"Let me confirm your requirements:\n" +
          "- Threat focus: [summary]\n" +
          "- Timeframe: [summary]\n" +
          "- Geographic scope: [summary]\n" +
          "- Key aspects: [summary]\n" +
          "- Data sources: [summary]\n\n" +
          "Is this correct, or would you like to adjust anything?\"\n\n" +
          "Suggested Question Flow Pattern\n" +
          "START\n" +
          "- [Initial broad question] -> Get threat type\n" +
          "- [Scope narrowing] -> Timeframe, geography, attack vectors\n" +
          "- [Depth selection] -> Technical vs. strategic focus\n" +
          "- [Collection planning] -> Sources, specific indicators\n" +
          "- [Confirmation] -> Validate and generate PIRs\n" +
          "- END (Proceed to Collection)\n\n" +
          "Example PIRs Generated from Dialogue\n" +
          "Priority Intelligence Requirements:\n" +
          "11. What TTPs has APT29 used in campaigns against Nordic countries in the last 6 months?\n" +
          "12. What infrastructure (domains, IPs) is associated with recent APT29 activity targeting government sectors?\n" +
          "13. What detection opportunities exist for APT29's documented TTPs?\n" +
          "14. What are the geopolitical motivations behind APT29's Nordic targeting?\n\n" +
          "Key Design Principles for Your AI Dialogue\n" +
          "Start broad, narrow progressively - Don't overwhelm with all questions at once\n" +
          "Skip irrelevant questions - If user says \"I uploaded specific data,\" don't ask about OSINT sources\n" +
          "Natural language - Avoid jargon initially, introduce it naturally\n" +
          "Context retention - Reference previous answers (\"Based on your focus on APT29...\")\n" +
          "Allow interruption - User should be able to say \"That's enough, proceed\" if they want minimal scope\n\n" +
          "Would you like me to draft specific prompt templates for each dialogue stage, or help design the conversation state machine?";

        const directionExample =
          "<div class=\"pill\">Direction Phase</div>" +
          "<div class=\"section-title\">Goals</div>" +
          "<div class=\"card list\">" +
          "<div>Define intelligence requirements - What specific questions need answering?</div>" +
          "<div>Establish scope and priorities - What matters most and what's out of scope?</div>" +
          "<div>Identify stakeholders - Who needs this intelligence and why?</div>" +
          "<div>Set collection boundaries - What sources, timeframes, and constraints apply?</div>" +
          "<div>Align with organizational needs - How does this support business/security objectives?</div>" +
          "</div>" +
          "<div class=\"section-title\">Core Questions Analysts Ask Themselves</div>" +
          "<div class=\"card\">" +
          "<div class=\"section-title\">Threat Focus</div>" +
          "<div class=\"list\">" +
          "<div>What specific threat am I investigating?</div>" +
          "<div>Is this about a threat actor, campaign, vulnerability, or general threat landscape?</div>" +
          "<div>Do I need technical details (TTPs, IOCs) or strategic context (attribution, motivation)?</div>" +
          "</div>" +
          "<div class=\"section-title\">Scope Definition</div>" +
          "<div class=\"list\">" +
          "<div>What time period am I interested in? (Recent activity, historical analysis, ongoing monitoring)</div>" +
          "<div>What geographic regions matter? (Global, specific countries, our infrastructure locations)</div>" +
          "<div>What assets/systems am I trying to protect?</div>" +
          "<div>What attack vectors or techniques am I most concerned about?</div>" +
          "</div>" +
          "<div class=\"section-title\">Depth vs. Breadth</div>" +
          "<div class=\"list\">" +
          "<div>Do I need a comprehensive overview or deep-dive analysis?</div>" +
          "<div>Am I looking for specific indicators or broader patterns?</div>" +
          "<div>Is this for immediate response or strategic planning?</div>" +
          "</div>" +
          "<div class=\"section-title\">Audience & Use Case</div>" +
          "<div class=\"list\">" +
          "<div>Who will consume this intelligence? (Executive, SOC, IR team, threat hunting)</div>" +
          "<div>What decision needs to be made with this intelligence?</div>" +
          "<div>What level of technical detail is appropriate?</div>" +
          "</div>" +
          "<div class=\"section-title\">Collection Constraints</div>" +
          "<div class=\"list\">" +
          "<div>What data sources are available/preferred?</div>" +
          "<div>Are there time constraints?</div>" +
          "<div>Are there sensitivity/classification requirements?</div>" +
          "</div>" +
          "</div>" +
          "<div class=\"section-title\">Suggested AI Dialogue Questions</div>" +
          "<div class=\"subtle\">Use a conversational flow that narrows scope progressively.</div>" +
          "<div class=\"card\">" +
          "<div class=\"section-title\">Opening Questions</div>" +
          "<div class=\"list\">" +
          "<div>1. What prompted this investigation? Are you responding to an incident, preparing for a threat, or conducting routine intelligence gathering?</div>" +
          "<div>2. What is your primary focus?</div>" +
          "<div class=\"subtle\">Actor  Campaign  Vulnerability  Landscape</div>" +
          "</div>" +
          "<div class=\"section-title\">Scope Refinement</div>" +
          "<div class=\"list\">" +
          "<div>3. What timeframe are you interested in?</div>" +
          "<div class=\"subtle\">Last 24 hours  Last week/month  Last 612 months  Historical</div>" +
          "<div>4. What geographic perspective matters most?</div>" +
          "<div class=\"subtle\">Global  Region  Specific location</div>" +
          "<div>5. What aspects are most important? (allow multiple)</div>" +
          "<div class=\"subtle\">Indicators  TTPs  Attribution  Target patterns  Impact</div>" +
          "</div>" +
          "<div class=\"section-title\">Technical Depth</div>" +
          "<div class=\"list\">" +
          "<div>6. What level of detail do you need?</div>" +
          "<div class=\"subtle\">Executive  Operational  Technical deepdive</div>" +
          "<div>7. Are there specific attack vectors you're concerned about?</div>" +
          "<div class=\"subtle\">Phishing  Network exploitation  Supply chain  Insider</div>" +
          "</div>" +
          "<div class=\"section-title\">Collection Planning</div>" +
          "<div class=\"list\">" +
          "<div>8. Which data sources should I prioritize?</div>" +
          "<div class=\"subtle\">OSINT  Uploaded data  All sources</div>" +
          "<div>9. Are there specific indicators or keywords I should focus on?</div>" +
          "<div class=\"subtle\">Malware families  Infrastructure patterns  Target industries</div>" +
          "</div>" +
          "<div class=\"section-title\">Validation</div>" +
          "<div class=\"list\">" +
          "<div>10. Let me confirm your requirements:</div>" +
          "<div class=\"subtle\">Threat focus  Timeframe  Geography  Key aspects  Data sources</div>" +
          "<div>Is this correct, or would you like to adjust anything?</div>" +
          "</div>" +
          "</div>" +
          "<div class=\"section-title\">Suggested Flow Pattern</div>" +
          "<div class=\"card list\">" +
          "<div>Start broad  Narrow scope  Select depth  Plan collection  Confirm  Proceed to Collection</div>" +
          "</div>" +
          "<div class=\"section-title\">Example PIRs</div>" +
          "<div class=\"card list\">" +
          "<div>11. What TTPs has APT29 used in campaigns against Nordic countries in the last 6 months?</div>" +
          "<div>12. What infrastructure (domains, IPs) is associated with recent APT29 activity targeting government sectors?</div>" +
          "<div>13. What detection opportunities exist for APT29's documented TTPs?</div>" +
          "<div>14. What are the geopolitical motivations behind APT29's Nordic targeting?</div>" +
          "</div>" +
          "<div class=\"section-title\">Design Principles</div>" +
          "<div class=\"card list\">" +
          "<div>Start broad, narrow progressively</div>" +
          "<div>Skip irrelevant questions</div>" +
          "<div>Use natural language and retain context</div>" +
          "<div>Allow interruption: \"That's enough, proceed\"</div>" +
          "</div>" +
          "<div class=\"divider\"></div>" +
          "<div class=\"subtle\">Would you like me to draft prompt templates for each stage, or help design the conversation state machine?</div>";

        let resp;
        if (isFirstUserMsg) {
          resp = { text: directionExamplePlain, richText: directionExample, runTrace: { steps: [] }, iocs: [], rich: true };
        } else if (isSecondUserMsg) {
          state.onboarding.completedStages.direction = true;
          state.onboarding.completedStages.planning = true;
          state.onboarding.currentStage = "collection";
          state.onboarding.stageOpen.collection = true;
          state.onboarding.stageOpen.planning = false;
          startPhaseRun("Collecting...", 5000);
          const collectionSummary =
            "<div class=\"pill\">Collection Phase</div>" +
            "<div class=\"section-title\">Collection Summary</div>" +
            "<div class=\"card\">Collected threat intelligence on APT29 activities targeting Nordic countries over the past 6 months from 3 data sources.</div>" +
            "<div class=\"section-title\">Collection Statistics</div>" +
            "<div class=\"card list\">" +
            "<div><strong>Time Period</strong>: January 2025 - June 2025</div>" +
            "<div><strong>Sources Queried</strong>: AlienVault OTX, MISP, Uploaded Files (2)</div>" +
            "<div><strong>Total Indicators Collected</strong>: 247</div>" +
            "<div><strong>Unique Campaigns Identified</strong>: 4</div>" +
            "<div><strong>MITRE ATT&CK Techniques Referenced</strong>: 18</div>" +
            "</div>" +
            "<div class=\"section-title\">Source 1: AlienVault OTX</div>" +
            "<div class=\"card\">" +
            "<div><strong>Query Parameters</strong>: \"APT29 Nordic government phishing\"</div>" +
            "<div><strong>Pulses Found</strong>: 12 relevant pulses</div>" +
            "<div><strong>Date Range</strong>: February 2025 - June 2025</div>" +
            "<div class=\"section-title\">Key Findings</div>" +
            "<div class=\"list\">" +
            "<div>67 malicious domains associated with APT29 infrastructure</div>" +
            "<div>23 IP addresses linked to command-and-control servers</div>" +
            "<div>15 file hashes (malware samples: Cobalt Strike, custom backdoors)</div>" +
            "<div>8 phishing email subjects targeting Norwegian government entities</div>" +
            "</div>" +
            "<div class=\"section-title\">Notable Campaigns</div>" +
            "<div class=\"list\">" +
            "<div>1. Operation Northern Light (March 2025) - Spearphishing with malicious PDFs; 12 IOCs</div>" +
            "<div>2. SolarWinds Follow-up Campaign (April-May 2025) - Supply chain targeting; 18 IOCs</div>" +
            "</div>" +
            "<div class=\"subtle\">Source Quality: High confidence, cross-validated indicators</div>" +
            "</div>" +
            "<div class=\"section-title\">Source 2: MISP Instance</div>" +
            "<div class=\"card\">" +
            "<div><strong>Query Parameters</strong>: Tags: \"APT29\", \"Nordic\", Geographic: \"NO, SE, DK, FI\"</div>" +
            "<div><strong>Events Found</strong>: 7 events</div>" +
            "<div><strong>Date Range</strong>: January 2025 - May 2025</div>" +
            "<div class=\"section-title\">Key Findings</div>" +
            "<div class=\"list\">" +
            "<div>89 indicators (45 domains, 28 IPs, 16 file hashes)</div>" +
            "<div>3 YARA rules for APT29 malware variants</div>" +
            "<div>4 Sigma rules for detection</div>" +
            "</div>" +
            "<div class=\"section-title\">Notable Events</div>" +
            "<div class=\"list\">" +
            "<div>Event #2847: APT29 Targeting Finnish Energy Sector (Feb 2025) - TLP AMBER</div>" +
            "<div>Event #3012: WellMess Malware Distribution (April 2025) - TLP GREEN</div>" +
            "</div>" +
            "<div class=\"subtle\">Source Quality: High confidence, verified by national CERTs</div>" +
            "</div>" +
            "<div class=\"section-title\">Source 3: Uploaded Files</div>" +
            "<div class=\"card\">" +
            "<div><strong>Files Processed</strong>: 2</div>" +
            "<div>1. apt29_iocs_internal.csv (125 rows)</div>" +
            "<div>2. incident_report_march2025.pdf (15 pages)</div>" +
            "<div class=\"section-title\">Key Findings from CSV</div>" +
            "<div class=\"list\">" +
            "<div>91 historical IOCs from internal investigations</div>" +
            "<div>34 IOCs overlap with OTX/MISP data</div>" +
            "<div>57 unique internal IOCs not found in public feeds</div>" +
            "</div>" +
            "<div class=\"section-title\">Key Findings from PDF Report</div>" +
            "<div class=\"list\">" +
            "<div>Incident timeline: March 15-18, 2025</div>" +
            "<div>Initial access: Spearphishing email to IT administrator</div>" +
            "<div>Lateral movement: 3 internal systems compromised</div>" +
            "<div>Exfiltration attempt blocked</div>" +
            "<div>12 internal network indicators (IPs, hostnames)</div>" +
            "</div>" +
            "<div class=\"subtle\">Source Quality: High confidence, internal verified data</div>" +
            "</div>" +
            "<div class=\"section-title\">Cross-Source Analysis</div>" +
            "<div class=\"card list\">" +
            "<div><strong>Indicator Overlap</strong>: 34 IOCs appear in 2+ sources; 11 in all 3 sources</div>" +
            "<div><strong>Timeline Correlation</strong>: Activity spike in March-April 2025</div>" +
            "<div><strong>Geographic Distribution</strong>: Norway 45%, Finland 25%, Sweden 20%, Denmark 10%</div>" +
            "<div><strong>Attack Vectors</strong>: Spearphishing 68%, Supply chain 22%, Credential stuffing 10%</div>" +
            "</div>" +
            "<div class=\"section-title\">Collection Gaps</div>" +
            "<div class=\"card list\">" +
            "<div>Limited visibility into APT29 activities in Denmark</div>" +
            "<div>No recent IOCs from Swedish sources (last update: January 2025)</div>" +
            "<div>Incomplete attribution data for 2 campaigns</div>" +
            "</div>" +
            "<div class=\"section-title\">Recommendations</div>" +
            "<div class=\"card list\">" +
            "<div>Query Swedish CERT feeds if available</div>" +
            "<div>Search for Danish-language phishing campaigns</div>" +
            "<div>Cross-reference with UK/US intelligence partners</div>" +
            "</div>" +
            "<div class=\"section-title\">Data Quality Assessment</div>" +
            "<div class=\"card list\">" +
            "<div>Completeness: 8/10 (gaps in SE/DK)</div>" +
            "<div>Timeliness: 9/10 (most data from last 30 days)</div>" +
            "<div>Relevance: 9/10 (matches PIRs)</div>" +
            "<div>Confidence: High (multi-source validation)</div>" +
            "</div>" +
            "<div class=\"section-title\">Next Steps</div>" +
            "<div class=\"card list\">" +
            "<div>Ready for Processing Phase</div>" +
            "<div> Sufficient data collected to answer PIRs</div>" +
            "<div> Cross-source validation completed</div>" +
            "<div> Data quality meets standards</div>" +
            "</div>" +
            "<div class=\"section-title\">Recommended Actions</div>" +
            "<div class=\"card list\">" +
            "<div>1. Proceed to normalization and correlation</div>" +
            "<div>2. Map indicators to MITRE ATT&CK framework</div>" +
            "<div>3. Generate perspective summaries (US, Norway, EU)</div>" +
            "</div>" +
            "<div class=\"section-title\">Human Review Required</div>" +
            "<div class=\"card list\">" +
            "<div>Approve collected data for processing</div>" +
            "<div>Request additional collection (optional)</div>" +
            "<div>Provide feedback on collection strategy</div>" +
            "</div>" +
            "<div class=\"action-buttons\">" +
            "<button class=\"primary\" data-action=\"collection-approve\">Approve Collection</button>" +
            "<button data-action=\"collection-deny\">Request More Collection</button>" +
            "</div>";
          resp = { text: "Collection in progress...", richText: collectionSummary, runTrace: { steps: [] }, iocs: [], rich: true, delay: 5000 };
        } else {
          resp = mockResponse(text, state.control);
        }

        if (!isFirstUserMsg && !isSecondUserMsg) {
          // Update intel panel
          state.intel.risk = Math.min(95, state.intel.risk + Math.floor(Math.random() * 15) + 5);
          resp.iocs.forEach((ioc) => {
            if (!state.intel.iocs.find((i) => i.value === ioc.value)) {
              state.intel.iocs.unshift(ioc);
            }
          });
        }

        const delay = resp.delay ?? 5000;
        setTimeout(() => {
          const cl = document.getElementById("chat-log");
          const nearBottomNow = cl ? cl.scrollHeight - cl.scrollTop - cl.clientHeight < 12 : true;
          if (nearBottomNow) state.forceScrollToBottom = true;
          const msg = {
            id: "msg_" + Date.now().toString(36), role: "assistant",
            content: resp.richText ? resp.richText : resp.text, createdAt: Date.now(),
            meta: { runTrace: resp.runTrace, rich: !!resp.richText },
          };
          getActive().messages.push(msg);
          state.run.active = false; state.run.stage = "Completed"; state.run.progress = 100;
          render();
        }, delay);
      };

      const runAnalysis = () => {
        if (state.run.active) return;
        startRun();
        const resp = mockResponse("(analysis)", state.control);
        state.intel.risk = Math.min(95, state.intel.risk + Math.floor(Math.random() * 10));
        const msg = {
          id: "msg_" + Date.now().toString(36), role: "assistant",
          content: "", createdAt: Date.now(),
          meta: { runTrace: resp.runTrace, showArtifacts: true },
        };
        getActive().messages.push(msg);
        streamText(resp.text, (chunk) => { msg.content = chunk; render(); },
          () => { state.run.active = false; state.run.stage = "Completed"; state.run.progress = 100; render(); },
          state.run.cancelToken || { cancelled: false });
      };

      /* ===== Render ===== */
      const renderMsg = (m) => {
        const safe = m.meta?.rich
          ? m.content
          : m.content.split("\n").map((l) => `<div>${l}</div>`).join("");
        const copy = m.role === "assistant" ? `<button data-action="copy" data-id="${m.id}">Copy</button>` : "";
        const trace = m.meta?.runTrace
          ? `<details class="run-trace"><summary>Run details</summary>${m.meta.runTrace.steps.map((s) => `<div class="run-step"><strong>${s.name}</strong> - ${s.duration}</div>`).join("")}</details>` : "";
        return `<div class="message ${m.role}"><div class="bubble">${safe}</div><div class="msg-actions"><span>${fmtTime(m.createdAt)}</span>${copy}</div>${trace}</div>`;
      };

      const renderOnboardingPanel = () => {
        if (!state.onboarding.active) return "";
        const idx = state.onboarding.stepIndex + 1;
        const total = onboardingScript.length;

        const stageCard = (id, title, meta, body, open) => {
          const active = state.onboarding.currentStage === id;
          const completed = !!state.onboarding.completedStages[id];
          return `
          <div class="ti-stage ${open ? "open" : ""}">
            <div class="ti-stage-header" data-action="ti-toggle" data-id="${id}">
              <div>
                <div class="ti-stage-title">${title}</div>
                <div class="ti-stage-meta">${meta}</div>
              </div>
              <div class="ti-stage-status">
                ${completed ? `<span class="ti-check" aria-hidden="true"></span>` : ""}
                ${active && !completed ? `<span class="ti-spinner" aria-hidden="true"></span>` : ""}
                <span>${open ? "Collapse" : "Expand"}</span>
              </div>
            </div>
            <div class="ti-stage-body">
              ${body}
            </div>
          </div>
        `;
        };

        const directionBody = `
          <div class="onb-header">
            <div>
              <div class="onb-title">Direction Phase (Mock Interaction)</div>
              <div class="onb-sub">Start broad, narrow progressively, then confirm and generate PIRs.</div>
            </div>
            <div class="onb-progress">Step ${idx} of ${total}</div>
          </div>
          <div class="onb-summary">
            <div class="onb-kicker">Current Position</div>
            <div>You are in the Direction phase. This panel only displays where you are in the cycle.</div>
          </div>
        `;

        return `
          <section class="onboarding-panel">
            ${stageCard("direction", "Direction", "Define requirements and scope", directionBody, state.onboarding.stageOpen.direction)}
            ${stageCard("planning", "Planning", "Confirm requirements and next steps", `<div class="onb-summary">Mock stage placeholder. Expand to review when ready.</div>`, state.onboarding.stageOpen.planning)}
            ${stageCard("collection", "Collection", "Identify sources and gather data", `<div class="onb-summary">Mock stage placeholder. Expand to review when ready.</div>`, state.onboarding.stageOpen.collection)}
            ${stageCard("processing", "Processing", "Normalize, enrich, and structure data", `<div class="onb-summary">Mock stage placeholder. Expand to review when ready.</div>`, state.onboarding.stageOpen.processing)}
            ${stageCard("analysis", "Analysis", "Derive insights and produce findings", `<div class="onb-summary">Mock stage placeholder. Expand to review when ready.</div>`, state.onboarding.stageOpen.analysis)}
          </section>
        `;
      };

      const renderIntelTab = () => {
        if (state.intelTab === "iocs") {
          return `
            <div class="risk-gauge">
              <div class="gauge-label">Threat Risk Score</div>
              <div class="gauge-value">${state.intel.risk}%</div>
              <div class="gauge-bar"><div class="gauge-fill" style="width:${state.intel.risk}%;background:${riskColor(state.intel.risk)}"></div></div>
            </div>
            <div class="metric-row">
              <div class="metric-card"><div class="mc-label">Indicators</div><div class="mc-value">${state.intel.iocs.length}</div></div>
              <div class="metric-card"><div class="mc-label">High Sev</div><div class="mc-value" style="color:var(--danger)">${state.intel.iocs.filter((i) => i.severity === "high").length}</div></div>
            </div>
            <div class="ioc-section-header"><h4>IOC Feed</h4><button data-action="add-ioc">+ Add</button></div>
            <div class="ioc-list">
              ${state.intel.iocs.map((ioc) => `
                <div class="ioc-item">
                  <div><span class="ioc-value">${ioc.value}</span><br/><span style="font-size:0.7rem;color:var(--muted)">${ioc.type}</span></div>
                  <span class="ioc-badge ${ioc.severity}">${ioc.severity}</span>
                </div>`).join("")}
            </div>`;
        }
        if (state.intelTab === "settings") {
          return `
            <div class="settings-group">
              <h4>Model Configuration</h4>
              <div class="settings-row"><label>Preset</label>
                <select data-action="model-preset">${["Fast (small)", "Balanced", "Deep (large)", "Custom"].map((o) => `<option ${state.control.modelPreset === o ? "selected" : ""}>${o}</option>`).join("")}</select>
              </div>
              <div class="settings-row"><label>Model count</label>
                <div class="cs-stepper"><button data-action="model-dec">-</button><span>${state.control.modelCount}</span><button data-action="model-inc">+</button></div>
              </div>
            </div>
            <div class="settings-group">
              <h4>AI Counsel</h4>
              <div class="settings-row"><label>Rounds</label>
                <select data-action="ai-rounds">${[1, 2, 3, 4, 5].map((o) => `<option ${state.control.aiRounds === o ? "selected" : ""}>${o}</option>`).join("")}</select>
              </div>
              <div class="settings-row"><label>Countries</label>
                <input type="text" data-action="ai-countries" value="${state.control.aiCountries.join(", ")}" placeholder="US, UK" />
              </div>
            </div>
            <div class="settings-group">
              <h4>Language</h4>
              <div class="settings-row"><label>Output language</label>
                <select data-action="language">${["English", "Norwegian (Bokmal)", "Chinese (Simplified)"].map((o) => `<option ${state.control.language === o ? "selected" : ""}>${o}</option>`).join("")}</select>
              </div>
            </div>`;
        }
        if (state.intelTab === "timeline") {
          const convo = getActive();
          const msgs = convo?.messages || [];
          if (!msgs.length) return `<div class="empty-state"><div class="es-icon">T</div><h3>No events yet</h3><p>Send a message to start building the timeline.</p></div>`;
          return `<div style="display:flex;flex-direction:column;gap:8px">
            ${msgs.map((m) => `
              <div style="border-left:3px solid ${m.role === "user" ? "var(--accent)" : m.role === "assistant" ? "var(--success)" : "var(--muted)"};padding:8px 12px;background:var(--panel-2);border-radius:var(--radius-xs);">
                <div style="font-size:0.72rem;text-transform:uppercase;color:var(--muted);margin-bottom:2px">${m.role} - ${fmtTime(m.createdAt)}</div>
                <div style="font-size:0.82rem">${m.content.slice(0, 120)}${m.content.length > 120 ? "..." : ""}</div>
              </div>`).join("")}
          </div>`;
        }
        return "";
      };

      const render = () => {
        ensureActive();
        document.documentElement.setAttribute("data-theme", state.theme);
        const convo = getActive();
        const query = state.searchQuery || "";
        const filtered = state.conversations.filter((c) => c.title.toLowerCase().includes(query.toLowerCase()));

        // Track if chat-log exists to know if this is initial render
        const oldChatLog = document.getElementById("chat-log");
        const oldScrollTop = oldChatLog ? oldChatLog.scrollTop : 0;
        const oldScrollHeight = oldChatLog ? oldChatLog.scrollHeight : 0;
        const oldClientHeight = oldChatLog ? oldChatLog.clientHeight : 0;
        const wasAtBottom = oldChatLog ? (oldScrollHeight - oldScrollTop - oldClientHeight < 50) : true;

        document.getElementById("app").innerHTML = `
          <div class="drawer-backdrop ${state.sidebarOpenMobile ? "active" : ""}" data-action="close-drawer"></div>
          <div class="app-shell">
            <!-- Sidebar -->
            <aside class="sidebar ${state.sidebarCollapsed ? "collapsed" : ""} ${state.sidebarOpenMobile ? "open" : ""}">
              <div class="sidebar-head">
                <div class="sidebar-brand">
                  <div class="logo">M</div>
                  <div><div class="brand-text">MCP Intel</div><div class="brand-sub">Prototype 5</div></div>
                </div>
                <button class="btn-new-session" data-action="new-chat">+ New Session</button>
                <div class="sidebar-search">
                  <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="11" cy="11" r="8"/><path d="m21 21-4.3-4.3"/></svg>
                  <input type="text" placeholder="Search conversations..." value="${query}" data-action="search" />
                </div>
              </div>
              <div class="conversation-list">
                ${filtered.map((c) => `
                  <div class="convo-item ${c.id === state.activeConversationId ? "active" : ""}" data-action="open" data-id="${c.id}">
                    <div><div class="convo-title">${c.title}</div><div class="convo-meta">${new Date(c.updatedAt).toLocaleDateString()} - ${c.messages.length} msgs</div></div>
                    <div class="convo-actions">
                      <button title="Rename" data-action="rename" data-id="${c.id}">R</button>
                      <button title="Delete" data-action="delete" data-id="${c.id}">X</button>
                    </div>
                  </div>`).join("")}
              </div>
            </aside>

            <!-- Main Content -->
            <div class="main-content">
              <div class="topbar">
                <div class="topbar-left">
                  <button class="btn-icon sidebar-toggle-mobile" data-action="open-drawer">Menu</button>
                  <button class="btn-icon" data-action="toggle-sidebar">${state.sidebarCollapsed ? "Show" : "Hide"} sidebar</button>
                  <div class="topbar-title">${convo?.title || "Conversation"}</div>
                  <div class="topbar-status"><div class="dot"></div>Ready</div>
                </div>
                <div class="topbar-right">
                  <button class="btn-icon" data-action="toggle-intel">${state.intelPanelCollapsed ? "Show" : "Hide"} Intel</button>
                  <button class="btn-icon" data-action="clear-chat">Clear</button>
                  <button class="btn-icon" data-action="toggle-theme">${state.theme === "light" ? "Dark" : "Light"}</button>
                </div>
              </div>

              <div class="workspace">
                <!-- Chat -->
                <div class="chat-area">
                  <div class="control-strip">
                    <div class="cs-group">
                      <span class="cs-label">Model</span>
                      <select class="cs-select" data-action="model-preset">
                        ${["Fast (small)", "Balanced", "Deep (large)", "Custom"].map((o) => `<option ${state.control.modelPreset === o ? "selected" : ""}>${o}</option>`).join("")}
                      </select>
                    </div>
                    <div class="cs-group">
                      <span class="cs-label">#</span>
                      <div class="cs-stepper"><button data-action="model-dec">-</button><span>${state.control.modelCount}</span><button data-action="model-inc">+</button></div>
                    </div>
                    <div class="cs-divider"></div>
                    <div class="cs-group">
                      <span class="cs-label">Counsel</span>
                      <select class="cs-select" data-action="ai-rounds">${[1, 2, 3, 4, 5].map((o) => `<option ${state.control.aiRounds === o ? "selected" : ""}>${o}</option>`).join("")}</select>
                      <span class="cs-label">rounds</span>
                    </div>
                    <div class="cs-divider"></div>
                    <button class="btn-upload" data-action="upload-files">Upload files</button>
                    <button class="btn-run" data-action="run-analysis">Run analysis</button>
                    <input type="file" id="file-input" multiple style="display:none" />
                  </div>

                  ${renderOnboardingPanel()}

                  <div class="progress-bar ${state.run.active ? "active" : ""}">
                    <div class="progress-track"><div class="progress-fill" style="width:${state.run.progress}%"></div></div>
                    <div class="progress-label">${state.run.stage || ""} ${state.run.progress}%</div>
                    <button class="btn-cancel" data-action="cancel-run">Cancel</button>
                  </div>

                  <div class="file-chips">
                    ${state.control.uploadedFiles.map((f) => `
                      <span class="chip">${f.name} (${Math.round(f.size / 1024)} KB)
                        <button data-action="remove-file" data-id="${f.id}">x</button>
                      </span>`).join("")}
                  </div>

                  <div class="chat-log" id="chat-log">
                    ${convo?.messages.length
                      ? convo.messages.map(renderMsg).join("")
                      : `<div class="empty-state">
                          <div class="es-icon">
                            <svg width="28" height="28" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M12 22c5.523 0 10-4.477 10-10S17.523 2 12 2 2 6.477 2 12s4.477 10 10 10z"/><path d="m9 12 2 2 4-4"/></svg>
                          </div>
                          <h3>Ready to analyze</h3>
                          <p>Type a message or upload files to begin your threat intelligence analysis.</p>
                        </div>`}
                  </div>

                  <button class="jump-latest" data-action="jump">Jump to latest</button>

                  <div class="composer">
                    <textarea id="composer-input" rows="1" placeholder="Describe your threat intel query..."></textarea>
                    <button id="send-btn" ${state.run.active ? "" : "disabled"} data-action="send">${state.run.active ? "Stop" : "Send"}</button>
                  </div>
                </div>

                <!-- Intel Panel -->
                <aside class="intel-panel ${state.intelPanelCollapsed ? "collapsed" : ""}">
                  <div class="intel-tabs">
                    <button class="intel-tab ${state.intelTab === "iocs" ? "active" : ""}" data-action="intel-tab" data-id="iocs">IOCs</button>
                    <button class="intel-tab ${state.intelTab === "settings" ? "active" : ""}" data-action="intel-tab" data-id="settings">Settings</button>
                    <button class="intel-tab ${state.intelTab === "timeline" ? "active" : ""}" data-action="intel-tab" data-id="timeline">Timeline</button>
                  </div>
                  <div class="intel-body">
                    ${renderIntelTab()}
                  </div>
                </aside>
              </div>
            </div>
          </div>`;

        // Post-render bindings
        const ta = document.getElementById("composer-input");
        const sendBtn = document.getElementById("send-btn");
        const chatLog = document.getElementById("chat-log");
        const jumpBtn = document.querySelector(".jump-latest");

        if (ta && sendBtn) {
          const updateSend = () => {
            if (!state.run.active) sendBtn.disabled = ta.value.trim().length === 0;
          };
          const autoGrow = () => { ta.style.height = "auto"; ta.style.height = Math.min(ta.scrollHeight, 160) + "px"; updateSend(); };
          ta.addEventListener("input", autoGrow);
          autoGrow();
        }

        if (chatLog && jumpBtn) {
          const onScroll = () => {
            const near = chatLog.scrollHeight - chatLog.scrollTop - chatLog.clientHeight < 12;
            jumpBtn.style.display = near ? "none" : "inline-flex";
          };
          chatLog.addEventListener("scroll", onScroll);

          // Preserve scroll position: stick to bottom only if user was already there
          if (state.forceScrollToBottom) {
            chatLog.scrollTop = chatLog.scrollHeight;
          } else {
            const maxTop = Math.max(0, chatLog.scrollHeight - chatLog.clientHeight);
            chatLog.scrollTop = Math.min(oldScrollTop, maxTop);
          }
          state.forceScrollToBottom = false;
          onScroll();
        }
      };

      /* ===== Event Handling ===== */
      const handleClick = (e) => {
        const el = e.target.closest("[data-action]");
        if (!el) return;
        const a = el.dataset.action;
        const id = el.dataset.id;

        if (a === "toggle-theme") { state.theme = state.theme === "light" ? "dark" : "light"; render(); return; }
        if (a === "toggle-sidebar") { state.sidebarCollapsed = !state.sidebarCollapsed; render(); return; }
        if (a === "toggle-intel") { state.intelPanelCollapsed = !state.intelPanelCollapsed; render(); return; }
        if (a === "new-chat") { createConversation(); render(); return; }
        if (a === "open" && id) { state.activeConversationId = id; state.sidebarOpenMobile = false; render(); return; }
        if (a === "rename" && id) { renameConversation(id); render(); return; }
        if (a === "delete" && id) { deleteConversation(id); render(); return; }
        if (a === "open-drawer") { state.sidebarOpenMobile = true; render(); return; }
        if (a === "close-drawer") { state.sidebarOpenMobile = false; render(); return; }
        if (a === "intel-tab" && id) { state.intelTab = id; render(); return; }
        if (a === "ti-toggle" && id) {
          state.onboarding.stageOpen[id] = !state.onboarding.stageOpen[id];
          render();
          return;
        }
        if (a === "collection-approve") {
          appendUser("Approve collection and proceed to processing.");
          state.onboarding.completedStages.collection = true;
          state.onboarding.currentStage = "processing";
          state.onboarding.stageOpen.processing = true;
          state.onboarding.stageOpen.collection = false;
          startPhaseRun("Processing...", 5000);
          const processingSummary =
            "<div class=\"pill\">Processing Phase</div>" +
            "<div class=\"section-title\">Overview</div>" +
            "<div class=\"card\">Completed processing of 247 indicators collected from 3 sources. Identified patterns, enriched IOCs, mapped to MITRE ATT&CK framework, and generated perspective summaries for US, Norway, and EU viewpoints.</div>" +
            "<div class=\"section-title\">Processing Statistics</div>" +
            "<div class=\"card list\">" +
            "<div><strong>Processing Duration</strong>: 3 minutes 42 seconds</div>" +
            "<div><strong>Indicators Normalized</strong>: 247/247 (100%)</div>" +
            "<div><strong>Correlations Identified</strong>: 23 clusters</div>" +
            "<div><strong>IOCs Enriched</strong>: 189/247 (76.5%)</div>" +
            "<div><strong>MITRE Techniques Mapped</strong>: 18 techniques across 8 tactics</div>" +
            "<div><strong>Perspective Summaries Generated</strong>: 3 (US, Norway, EU)</div>" +
            "</div>" +
            "<div class=\"divider\"></div>" +
            "<div class=\"section-title\">1. Data Normalization</div>" +
            "<div class=\"section-title\">Format Standardization</div>" +
            "<div class=\"card list\">" +
            "<div>Converted all timestamps to ISO 8601 UTC</div>" +
            "<div>Standardized IP addresses (removed CIDR notation where inappropriate)</div>" +
            "<div>Normalized domain names (lowercase, removed protocols)</div>" +
            "<div>Unified file hash formats (lowercase hex)</div>" +
            "<div>Mapped indicator types to STIX 2.1 taxonomy</div>" +
            "</div>" +
            "<div class=\"section-title\">Normalization Results</div>" +
            "<div class=\"card list\">" +
            "<div>IPv4 Addresses: 103 raw / 98 normalized / 5 duplicates removed</div>" +
            "<div>Domains: 120 raw / 115 normalized / 5 duplicates removed</div>" +
            "<div>File Hashes (SHA256): 52 raw / 52 normalized / 0 duplicates removed</div>" +
            "<div>Email Addresses: 8 raw / 8 normalized / 0 duplicates removed</div>" +
            "<div><strong>Total</strong>: 283 raw / 273 normalized / 10 duplicates removed</div>" +
            "</div>" +
            "<div class=\"section-title\">Data Quality PostNormalization</div>" +
            "<div class=\"card list\">" +
            "<div> All indicators conform to standard formats</div>" +
            "<div> Duplicates removed</div>" +
            "<div> Invalid indicators flagged (14 items)</div>" +
            "</div>" +
            "<div class=\"section-title\">Invalid Indicators Identified</div>" +
            "<div class=\"card list\">" +
            "<div>8 IPs from private RFC1918 ranges</div>" +
            "<div>4 domains with invalid TLD (.local, .internal)</div>" +
            "<div>2 malformed email addresses</div>" +
            "</div>" +
            "<div class=\"divider\"></div>" +
            "<div class=\"section-title\">2. Correlation Analysis</div>" +
            "<div class=\"card list\">" +
            "<div>Correlation Clusters Identified: 23</div>" +
            "<div><strong>Cluster 1: Operation Northern Light</strong> (High confidence)</div>" +
            "<div><strong>Cluster 2: SolarWinds Followup</strong> (Medium confidence)</div>" +
            "<div><strong>Cluster 3: WellMess Malware Distribution</strong> (High confidence)</div>" +
            "<div>Clusters 412: Medium confidence</div>" +
            "<div>Clusters 1323: Low confidence</div>" +
            "</div>" +
            "<div class=\"section-title\">Correlation Network Graph</div>" +
            "<div class=\"card\">Graph generated to visualize shared infrastructure, time overlap, and TTP convergence.</div>" +
            "<div class=\"divider\"></div>" +
            "<div class=\"section-title\">Processing Complete</div>" +
            "<div class=\"card list\">" +
            "<div> Data normalized and enriched</div>" +
            "<div> Correlation clusters generated</div>" +
            "<div> MITRE ATT&CK mappings complete</div>" +
            "</div>";
          const analysisPrompt =
            "<div class=\"pill\">Analysis Phase</div>" +
            "<div class=\"section-title\">Ready To Proceed</div>" +
            "<div class=\"card\">Processing is complete. Proceed to Analysis when ready.</div>" +
            "<div class=\"action-buttons\">" +
            "<button class=\"primary\" data-action=\"analysis-proceed\">Proceed to Analysis</button>" +
            "</div>";
          setTimeout(() => {
            const cl = document.getElementById("chat-log");
            const nearBottomNow = cl ? cl.scrollHeight - cl.scrollTop - cl.clientHeight < 12 : true;
            if (nearBottomNow) state.forceScrollToBottom = true;
            const msg = {
              id: "msg_" + Date.now().toString(36), role: "assistant",
              content: processingSummary, createdAt: Date.now(),
              meta: { runTrace: { steps: [] }, rich: true },
            };
            getActive().messages.push(msg);
            const promptMsg = {
              id: "msg_" + Date.now().toString(36), role: "assistant",
              content: analysisPrompt, createdAt: Date.now(),
              meta: { runTrace: { steps: [] }, rich: true },
            };
            getActive().messages.push(promptMsg);
            state.onboarding.completedStages.processing = true;
            state.run.active = false; state.run.stage = "Completed"; state.run.progress = 100;
            render();
          }, 5000);
          render();
          return;
        }
        if (a === "collection-deny") {
          appendUser("Request additional collection.");
          state.onboarding.currentStage = "collection";
          state.onboarding.stageOpen.collection = true;
          render();
          return;
        }
        if (a === "analysis-proceed") {
          appendUser("Proceed to analysis.");
          state.onboarding.currentStage = "analysis";
          state.onboarding.stageOpen.analysis = true;
          startPhaseRun("Analyzing...", 2500);
          const analysisSummary =
            "<div class=\"pill\">Analysis Phase</div>" +
            "<div class=\"section-title\">Overview</div>" +
            "<div class=\"card\">Completed processing of 247 indicators collected from 3 sources. Identified patterns, enriched IOCs, mapped to MITRE ATT&CK framework, and generated perspective summaries for US, Norway, and EU viewpoints.</div>" +
            "<div class=\"section-title\">Processing Statistics</div>" +
            "<div class=\"card list\">" +
            "<div><strong>Processing Duration</strong>: 3 minutes 42 seconds</div>" +
            "<div><strong>Indicators Normalized</strong>: 247/247 (100%)</div>" +
            "<div><strong>Correlations Identified</strong>: 23 clusters</div>" +
            "<div><strong>IOCs Enriched</strong>: 189/247 (76.5%)</div>" +
            "<div><strong>MITRE Techniques Mapped</strong>: 18 techniques across 8 tactics</div>" +
            "<div><strong>Perspective Summaries Generated</strong>: 3 (US, Norway, EU)</div>" +
            "</div>" +
            "<div class=\"divider\"></div>" +
            "<div class=\"section-title\">1. Data Normalization</div>" +
            "<div class=\"section-title\">Format Standardization</div>" +
            "<div class=\"card list\">" +
            "<div>Converted all timestamps to ISO 8601 UTC</div>" +
            "<div>Standardized IP addresses (removed CIDR notation where inappropriate)</div>" +
            "<div>Normalized domain names (lowercase, removed protocols)</div>" +
            "<div>Unified file hash formats (lowercase hex)</div>" +
            "<div>Mapped indicator types to STIX 2.1 taxonomy</div>" +
            "</div>" +
            "<div class=\"section-title\">Normalization Results</div>" +
            "<div class=\"card list\">" +
            "<div>IPv4 Addresses: 103 raw / 98 normalized / 5 duplicates removed</div>" +
            "<div>Domains: 120 raw / 115 normalized / 5 duplicates removed</div>" +
            "<div>File Hashes (SHA256): 52 raw / 52 normalized / 0 duplicates removed</div>" +
            "<div>Email Addresses: 8 raw / 8 normalized / 0 duplicates removed</div>" +
            "<div><strong>Total</strong>: 283 raw / 273 normalized / 10 duplicates removed</div>" +
            "</div>" +
            "<div class=\"section-title\">Data Quality PostNormalization</div>" +
            "<div class=\"card list\">" +
            "<div> All indicators conform to standard formats</div>" +
            "<div> Duplicates removed</div>" +
            "<div> Invalid indicators flagged (14 items - see details below)</div>" +
            "</div>" +
            "<div class=\"section-title\">Invalid Indicators Identified</div>" +
            "<div class=\"card list\">" +
            "<div>8 IPs from private RFC1918 ranges (10.x.x.x, 192.168.x.x)</div>" +
            "<div>4 domains with invalid TLD (.local, .internal)</div>" +
            "<div>2 malformed email addresses</div>" +
            "</div>" +
            "<div class=\"divider\"></div>" +
            "<div class=\"section-title\">2. Correlation Analysis</div>" +
            "<div class=\"section-title\">Correlation Clusters Identified: 23</div>" +
            "<div class=\"card list\">" +
            "<div><strong>Cluster 1: Operation Northern Light Infrastructure</strong> (High confidence)</div>" +
            "<div>Indicators: 34 (12 domains, 15 IPs, 7 file hashes)</div>" +
            "<div>Timeframe: March 1-18, 2025</div>" +
            "<div>Confidence: 9.2/10</div>" +
            "<div>Pattern Analysis: 48-hour domain registration window, NiceVPS registrar, AS64512, round-robin DNS, selfsigned TLS</div>" +
            "<div>Behavioral Correlation: Phishing campaign, C2 activity, Cobalt Strike beacons</div>" +
            "<div>Attribution Indicators: Matches known APT29 tradecraft</div>" +
            "<div>Evidence Quality: Strong</div>" +
            "</div>" +
            "<div class=\"card list\">" +
            "<div><strong>Cluster 2: SolarWinds Followup Supply Chain</strong> (Medium confidence)</div>" +
            "<div>Indicators: 18 (10 IPs, 5 domains, 3 file hashes)</div>" +
            "<div>Timeframe: April 15 - May 20, 2025</div>" +
            "<div>Confidence: 6.8/10</div>" +
            "<div>Pattern Analysis: Typosquatting, cloud infrastructure, stolen code signing certs</div>" +
            "<div>Behavioral Correlation: Trojanized updates, beaconing, download servers</div>" +
            "<div>Attribution Indicators: Code reuse (68% similarity)</div>" +
            "<div>Evidence Quality: Moderate</div>" +
            "</div>" +
            "<div class=\"card list\">" +
            "<div><strong>Cluster 3: WellMess Malware Distribution</strong> (High confidence)</div>" +
            "<div>Indicators: 27 (15 domains, 8 IPs, 4 file hashes)</div>" +
            "<div>Timeframe: April 1 - June 10, 2025</div>" +
            "<div>Confidence: 8.9/10</div>" +
            "<div>Pattern Analysis: Compromised WordPress sites, dedicated C2 IPs</div>" +
            "<div>Behavioral Correlation: HTTP POST /api/v2/update, 7day exfil cadence</div>" +
            "<div>Attribution Indicators: WellMess TTP overlap</div>" +
            "<div>Evidence Quality: Strong</div>" +
            "</div>" +
            "<div class=\"card list\">" +
            "<div><strong>Other Clusters</strong>: 20 additional clusters</div>" +
            "<div>Clusters 412: Medium confidence (47/10)</div>" +
            "<div>Clusters 1323: Low confidence (24/10)</div>" +
            "</div>" +
            "<div class=\"section-title\">Correlation Network Graph</div>" +
            "<div class=\"card\">Graph generated to visualize shared infrastructure, time overlap, and TTP convergence.</div>" +
            "<div class=\"section-title\">Analysis Complete</div>" +
            "<div class=\"card\">Download outputs for distribution or archive.</div>" +
            "<div class=\"action-buttons\">" +
            "<button class=\"primary\" data-action=\"download-report\">Download Report</button>" +
            "<button data-action=\"download-json\">Download JSON</button>" +
            "</div>";
          setTimeout(() => {
            const cl = document.getElementById("chat-log");
            const nearBottomNow = cl ? cl.scrollHeight - cl.scrollTop - cl.clientHeight < 12 : true;
            if (nearBottomNow) state.forceScrollToBottom = true;
            const msg = {
              id: "msg_" + Date.now().toString(36), role: "assistant",
              content: analysisSummary, createdAt: Date.now(),
              meta: { runTrace: { steps: [] }, rich: true },
            };
            getActive().messages.push(msg);
            state.onboarding.completedStages.analysis = true;
            state.onboarding.currentStage = "analysis";
            render();
          }, 2500);
          return;
        }
        if (a === "send") {
          if (state.run.active) { if (state.run.cancelToken) state.run.cancelToken.cancelled = true; }
          else sendMessage();
          return;
        }
        if (a === "copy" && id) {
          const msg = getActive()?.messages.find((m) => m.id === id);
          if (msg) navigator.clipboard.writeText(msg.content || "");
          return;
        }
        if (a === "clear-chat") {
          const c = getActive();
          if (c && confirm("Clear this chat?")) { c.messages = []; c.updatedAt = Date.now(); state.uploadPrompted = false; render(); }
          return;
        }
        if (a === "jump") {
          const cl = document.getElementById("chat-log");
          if (cl) cl.scrollTop = cl.scrollHeight;
          state.forceScrollToBottom = true;
          return;
        }
        if (a === "upload-files") { document.getElementById("file-input").click(); return; }
        if (a === "remove-file" && id) { state.control.uploadedFiles = state.control.uploadedFiles.filter((f) => f.id !== id); render(); return; }
        if (a === "model-dec") { state.control.modelCount = Math.max(1, state.control.modelCount - 1); render(); return; }
        if (a === "model-inc") { state.control.modelCount = Math.min(5, state.control.modelCount + 1); render(); return; }
        if (a === "download-report") { dlReport(); return; }
        if (a === "download-json") { dlJson(); return; }
        if (a === "run-analysis") { runAnalysis(); return; }
        if (a === "cancel-run") { if (state.run.cancelToken) state.run.cancelToken.cancelled = true; return; }
        if (a === "add-ioc") {
          const samples = [
            { value: "suspicious-login.net", type: "domain", severity: "high" },
            { value: "5.6.7.8", type: "ip", severity: "medium" },
            { value: "aa12bb34cc", type: "hash", severity: "low" },
          ];
          state.intel.iocs.unshift(samples[Math.floor(Math.random() * samples.length)]);
          state.intel.risk = Math.min(95, state.intel.risk + Math.floor(Math.random() * 5) + 2);
          render();
          return;
        }
      };

      const handleInput = (e) => {
        if (e.target.matches("[data-action='search']")) { state.searchQuery = e.target.value; render(); return; }
        if (e.target.matches("[data-action='model-preset']")) { state.control.modelPreset = e.target.value; render(); return; }
        if (e.target.matches("[data-action='ai-rounds']")) { state.control.aiRounds = Number(e.target.value); render(); return; }
        if (e.target.matches("[data-action='ai-countries']")) {
          state.control.aiCountries = e.target.value.split(",").map((c) => c.trim()).filter((c) => c);
          return;
        }
        if (e.target.matches("[data-action='language']")) { state.control.language = e.target.value; render(); return; }
      };

      const handleKeydown = (e) => {
        if (!e.target.closest("#composer-input")) return;
        if (e.key === "Enter" && !e.shiftKey) { e.preventDefault(); sendMessage(); }
      };

      const handleFileChange = (e) => {
        const files = Array.from(e.target.files || []);
        state.control.uploadedFiles = state.control.uploadedFiles.concat(
          files.map((f) => ({ id: "f_" + Date.now().toString(36) + Math.random().toString(36), name: f.name, size: f.size }))
        );
        e.target.value = "";
        render();
      };

      /* ===== Init ===== */
      ensureActive();

      document.addEventListener("click", handleClick);
      document.addEventListener("input", handleInput);
      document.addEventListener("keydown", handleKeydown);
      document.addEventListener("change", (e) => { if (e.target.id === "file-input") handleFileChange(e); });

      render();
    </script>
  </body>
</html>
